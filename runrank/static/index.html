<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>RunRank</title>

  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#0f0f12">

  <style>
    :root{
      --bg:#0b0b0f;
      --device:#e9e9ee;
      --device2:#d7d7de;
      --shadow: rgba(0,0,0,.35);
      --screen:#0f1620;
      --screen2:#121b27;
      --text:#eaf0ff;
      --muted:#9db0d1;
      --accent:#7bdcff;
      --line: rgba(255,255,255,.12);
      --danger:#ff6b6b;
      --ok:#6bffb0;
      --radius: 26px;
      --screenRadius: 12px;
      --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", "Apple SD Gothic Neo", Helvetica, Arial, sans-serif;
    }
    html,body{height:100%; margin:0; background: radial-gradient(1200px 800px at 70% 20%, #1a2b3a 0%, var(--bg) 55%, #06060a 100%); color:var(--text); font-family:var(--font);}
    *{box-sizing:border-box;}
    a{color:inherit}

    .wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:26px 18px;}
    .ipod{width:min(360px, 92vw);aspect-ratio:9/14;border-radius:36px;background:linear-gradient(180deg,var(--device) 0%,var(--device2) 100%);box-shadow:0 24px 70px var(--shadow);padding:18px 16px 20px;position:relative;}
    .ipod:before{content:"";position:absolute;inset:10px 10px auto 10px;height:20px;border-radius:16px;background:rgba(255,255,255,.35);filter:blur(.2px);}

    .screen{height:40%;border-radius:var(--screenRadius);background:linear-gradient(180deg,var(--screen2),var(--screen));border:1px solid rgba(0,0,0,.25);box-shadow:inset 0 0 0 1px rgba(255,255,255,.06);padding:10px 10px 12px;overflow:hidden;position:relative;}
    .status{display:flex;align-items:center;justify-content:space-between;font-size:12px;color:var(--muted);letter-spacing:.2px;padding:2px 2px 6px;}
    .status .pill{font-size:11px;padding:2px 8px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.09);color:var(--muted);}

    .view{height:calc(100% - 26px);display:flex;flex-direction:column;gap:8px;}
    .titleRow{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:0 2px;}
    .titleRow h1{margin:0;font-size:14px;font-weight:800;letter-spacing:.4px;}
    .titleRow .hint{font-size:11px;color:var(--muted);}

    .list{flex:1;overflow:auto;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);padding:6px;}
    .item{display:flex;align-items:center;gap:10px;padding:8px 8px;border-radius:10px;cursor:default;user-select:none;}
    .item + .item{margin-top:6px;}
    .item .thumb{width:28px;height:28px;border-radius:6px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.10);overflow:hidden;flex:0 0 auto;display:grid;place-items:center;color:rgba(255,255,255,.55);font-size:12px;}
    .item .thumb img{width:100%;height:100%;object-fit:cover;display:block;}
    .item .meta{min-width:0;}
    .item .meta .name{font-size:12px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;line-height:1.2;}
    .item .meta .sub{margin-top:2px;font-size:11px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;line-height:1.2;}
    .item .right{margin-left:auto;font-size:12px;color:var(--muted);font-variant-numeric:tabular-nums;}
    .item.active{background:rgba(123,220,255,.16);border:1px solid rgba(123,220,255,.30);}
    .item.active .right{color:var(--text);}

    .detail{
      display:flex;
      flex-direction:column;
      gap:10px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.04);
      padding:10px;
      height:100%;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      padding-bottom: 22px;
    }

    .wheelWrap{height:60%;display:flex;align-items:center;justify-content:center;padding-top:14px;}
    .wheel{width:82%;aspect-ratio:1/1;border-radius:999px;background:radial-gradient(circle at 35% 30%,rgba(255,255,255,.65),rgba(255,255,255,.22) 35%,rgba(0,0,0,.05) 66%,rgba(0,0,0,.10) 100%);border:1px solid rgba(0,0,0,.20);box-shadow:inset 0 0 0 1px rgba(255,255,255,.35),0 10px 28px rgba(0,0,0,.16);position:relative;user-select:none;touch-action:none;}
    .wheel .center{position:absolute;inset:30%;border-radius:999px;background:radial-gradient(circle at 30% 30%,rgba(255,255,255,.85),rgba(255,255,255,.20) 60%,rgba(0,0,0,.06) 100%);border:1px solid rgba(0,0,0,.20);box-shadow:inset 0 0 0 1px rgba(255,255,255,.35);display:grid;place-items:center;font-weight:900;color:rgba(20,20,24,.65);cursor:pointer;}
    .wheelBtn{position:absolute;display:grid;place-items:center;width:36%;height:20%;font-size:12px;font-weight:900;color:rgba(20,20,24,.65);cursor:pointer;}
    .wheelBtn.top{top:4%;left:32%;}
    .wheelBtn.bottom{bottom:4%;left:32%;}
    .wheelBtn.left{left:4%;top:40%;}
    .wheelBtn.right{right:4%;top:40%;}
    .wheelBtn small{font-size:10px;letter-spacing:.6px;}
    .wheelBtn svg { fill: rgba(20,20,24,.65); }
    .wheelBtn:active { transform: scale(.98); }

    .toast{position:absolute;left:10px;right:10px;bottom:10px;padding:10px 12px;border-radius:12px;background:rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.12);color:var(--text);font-size:12px;display:none;backdrop-filter:blur(8px);}
    .toast.show{display:block;}
    .toast .sub{color:rgba(255,255,255,.75);margin-top:3px;font-size:11px;}

    .kbd{font-size:11px;color:var(--muted);padding:0 2px;}
    .kbd code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:10px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.10);padding:2px 6px;border-radius:8px;color:var(--text);}

    input,select{width:100%;padding:10px 10px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.25);color:var(--text);outline:none;}
    label{font-size:11px;color:var(--muted);}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px;}

    .btn{border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);color:var(--text);padding:10px 10px;border-radius:12px;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:6px;}
    .btn.primary{background:rgba(123,220,255,.18);border-color:rgba(123,220,255,.32);}
    .cta{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="ipod">
      <div class="screen">
        <div class="status">
          <div class="pill" id="pillState">OFFLINE</div>
          <div id="clock">--:--</div>
        </div>

        <div class="view" id="view"></div>

        <div class="toast" id="toast">
          <div id="toastTitle">ì•Œë¦¼</div>
          <div class="sub" id="toastSub"></div>
        </div>
      </div>

      <div class="wheelWrap">
        <div class="wheel" aria-label="Clickwheel">
          <div class="wheelBtn top" id="btnMenu"><small>MENU</small></div>
          <div class="wheelBtn left" id="btnPrev" aria-label="Previous">
            <svg viewBox="0 0 24 24" width="22" height="22"><path d="M6 5h2v14H6zM20 6v12l-10-6z"/></svg>
          </div>
          <div class="wheelBtn right" id="btnNext" aria-label="Next">
            <svg viewBox="0 0 24 24" width="22" height="22"><path d="M16 5h2v14h-2zM4 6v12l10-6z"/></svg>
          </div>
          <div class="wheelBtn bottom" id="btnPlay" aria-label="Play/Pause">
            <svg id="iconPlay" viewBox="0 0 24 24" width="22" height="22"><path d="M8 5v14l11-7z"/></svg>
          </div>
          <div class="center" id="btnCenter">SELECT</div>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  // Service Worker
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', async () => {
      try {
        const reg = await navigator.serviceWorker.register('/service-worker.js');
        try { await reg.update(); } catch (e) {}
      } catch (e) {}
    });
  }

  const state = {
    page: 'menu',
    menuIndex: 0,
    listIndex: 0,
    tracks: [],
    ranking: [],
    hot: [],
    runs: [],
    selectedTrack: null,
    checkedTrackIds: new Set(),
    online: true,
  };

  const MENU = [
    { key: 'tracks',   label: 'Tracks',   hint: 'ê³¡ ëª©ë¡ / ì¶”ì²œ' },
    { key: 'ranking',  label: 'Ranking',  hint: 'ì „ì²´ ë­í‚¹' },
    { key: 'hot',      label: 'Hot',      hint: 'ìµœê·¼ ì¸ê¸°' },
    { key: 'runs',     label: 'Runs',     hint: 'ëŸ°ë‹ ê¸°ë¡ + ì‚¬ì§„' },
    { key: 'settings', label: 'Settings', hint: 'ë‹‰ë„¤ì„ / ì˜µì…˜' },
    { key: 'about',    label: 'About',    hint: 'ì•± ì •ë³´' },
  ];

  const el = {
    view: document.getElementById('view'),
    toast: document.getElementById('toast'),
    toastTitle: document.getElementById('toastTitle'),
    toastSub: document.getElementById('toastSub'),
    pill: document.getElementById('pillState'),
    clock: document.getElementById('clock'),
    btnMenu: document.getElementById('btnMenu'),
    btnPrev: document.getElementById('btnPrev'),
    btnNext: document.getElementById('btnNext'),
    btnPlay: document.getElementById('btnPlay'),
    btnCenter: document.getElementById('btnCenter'),
  };

  function fmtClock(d = new Date()) {
    const hh = String(d.getHours()).padStart(2, '0');
    const mm = String(d.getMinutes()).padStart(2, '0');
    return `${hh}:${mm}`;
  }

  function showToast(title, sub = '') {
    el.toastTitle.textContent = title;
    el.toastSub.textContent = sub;
    el.toast.classList.add('show');
    clearTimeout(showToast._t);
    showToast._t = setTimeout(() => el.toast.classList.remove('show'), 1800);
  }

  function safeText(s) { return (s ?? '').toString(); }

  function escapeHtml(s) {
    return String(s ?? '').replace(/[&<>"']/g, c => ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
    }[c]));
  }
  function escapeAttr(s) { return escapeHtml(s).replace(/"/g, '&quot;'); }

  function getNick() { return localStorage.getItem('runrank_nick') || ''; }
  function setNick(v) { localStorage.setItem('runrank_nick', v); }

  // Online check
  let onlineFailStreak = 0;
  async function checkOnline() {
    try {
      const r = await fetch(`/api/health?ts=${Date.now()}`, { cache: 'no-store', credentials: 'same-origin' });
      if (r.ok) { onlineFailStreak = 0; state.online = true; }
      else { onlineFailStreak += 1; if (onlineFailStreak >= 2) state.online = false; }
    } catch {
      onlineFailStreak += 1; if (onlineFailStreak >= 2) state.online = false;
    }
    render();
  }
  function startOnlineMonitor() { checkOnline(); setInterval(checkOnline, 15000); }

  // Spotify (PKCE) - ìµœì†Œ ë¼ˆëŒ€
  function getSpotifyClientId() { return localStorage.getItem('runrank_spotify_client_id') || ''; }
  function setSpotifyClientId(v) { localStorage.setItem('runrank_spotify_client_id', v); }
  function getSpotifyToken() { return localStorage.getItem('runrank_spotify_access_token') || ''; }
  function setSpotifyToken(v) { localStorage.setItem('runrank_spotify_access_token', v); }

  async function sha256(str) {
    const enc = new TextEncoder();
    const data = enc.encode(str);
    const hash = await crypto.subtle.digest('SHA-256', data);
    return new Uint8Array(hash);
  }
  function base64url(bytes) {
    let str = '';
    bytes.forEach(b => str += String.fromCharCode(b));
    return btoa(str).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/,'');
  }
  function randString(len = 64) {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
    let out = '';
    const arr = crypto.getRandomValues(new Uint8Array(len));
    for (let i = 0; i < len; i++) out += chars[arr[i] % chars.length];
    return out;
  }

  async function spotifyLogin() {
    const clientId = getSpotifyClientId().trim();
    if (!clientId) return showToast('Spotify', 'Settingsì— Client IDë¶€í„° ë„£ì–´');

    const verifier = randString(64);
    const challenge = base64url(await sha256(verifier));
    const stateStr = randString(16);
    localStorage.setItem('runrank_spotify_verifier', verifier);
    localStorage.setItem('runrank_spotify_oauth_state', stateStr);

    const redirectUri = window.location.origin + '/';
    const scope = ['user-read-email','user-read-private','playlist-read-private','playlist-read-collaborative'].join(' ');

    const params = new URLSearchParams({
      client_id: clientId,
      response_type: 'code',
      redirect_uri: redirectUri,
      code_challenge_method: 'S256',
      code_challenge: challenge,
      state: stateStr,
      scope,
    });
    window.location.href = 'https://accounts.spotify.com/authorize?' + params.toString();
  }

  async function handleSpotifyCallback() {
    const url = new URL(window.location.href);
    const code = url.searchParams.get('code');
    const stateStr = url.searchParams.get('state');
    const err = url.searchParams.get('error');

    if (err) {
      showToast('Spotify ì‹¤íŒ¨', err);
      url.searchParams.delete('error');
      window.history.replaceState({}, '', url.toString());
      return;
    }
    if (!code) return;

    const expectedState = localStorage.getItem('runrank_spotify_oauth_state') || '';
    const verifier = localStorage.getItem('runrank_spotify_verifier') || '';
    const clientId = getSpotifyClientId().trim();
    const redirectUri = window.location.origin + '/';

    if (!clientId || !verifier || !expectedState || expectedState !== stateStr) {
      showToast('Spotify', 'state/verifier ë¶ˆì¼ì¹˜');
      return;
    }

    try {
      const body = new URLSearchParams({
        client_id: clientId,
        grant_type: 'authorization_code',
        code,
        redirect_uri: redirectUri,
        code_verifier: verifier,
      });

      const res = await fetch('https://accounts.spotify.com/api/token', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body,
      });

      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data?.error_description || data?.error || String(res.status));
      if (data?.access_token) { setSpotifyToken(data.access_token); showToast('Spotify', 'ì—°ë™ ì™„ë£Œ'); }
    } catch (e) {
      showToast('Spotify ì‹¤íŒ¨', String(e.message || e).slice(0, 80));
    } finally {
      url.searchParams.delete('code'); url.searchParams.delete('state');
      window.history.replaceState({}, '', url.toString());
    }
  }

  function pickCoverUrl(x) { return x?.cover_url || x?.album_art || x?.image_url || ''; }

  async function apiGet(path) {
    const res = await fetch(path, { cache: 'no-store' });
    if (!res.ok) throw new Error(`${res.status}`);
    return await res.json();
  }

  async function refreshAll() {
    try {
      const [tracks, ranking, hot] = await Promise.all([
        apiGet('/api/tracks'),
        apiGet('/api/ranking'),
        apiGet('/api/hot_ranking'),
      ]);
      state.tracks = Array.isArray(tracks) ? tracks : (tracks?.tracks || []);
      state.ranking = Array.isArray(ranking) ? ranking : (ranking?.ranking || []);
      state.hot = Array.isArray(hot) ? hot : (hot?.ranking || []);
      state.online = true;
      render();
    } catch (e) {
      showToast('ì˜¤í”„ë¼ì¸', 'ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•´ì¤˜');
      state.online = false;
      render();
    }
  }

  async function refreshRuns() {
    try {
      const nick = getNick();
      const qs = nick ? `?user=${encodeURIComponent(nick)}` : '';
      const runs = await apiGet('/api/runs' + qs);
      state.runs = Array.isArray(runs) ? runs : [];
      render();
    } catch (e) {
      showToast('Runs ì‹¤íŒ¨', 'ì„œë²„ ì‘ë‹µì´ ì´ìƒí•´');
    }
  }

  async function submit(trackId) {
    try {
      const body = { track_id: Number(trackId), user: getNick() || null };
      const res = await fetch('/api/submit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok || data?.ok === false) throw new Error(data?.error || `${res.status}`);
      showToast('ì¶”ì²œ ì™„ë£Œ', 'ë­í‚¹ì— ë°˜ì˜ëì–´');

      const [ranking, hot] = await Promise.all([
        apiGet('/api/ranking'),
        apiGet('/api/hot_ranking'),
      ]);
      state.ranking = Array.isArray(ranking) ? ranking : (ranking?.ranking || []);
      state.hot = Array.isArray(hot) ? hot : (hot?.ranking || []);
      render();
    } catch (e) {
      showToast('ì‹¤íŒ¨', String(e.message || 'ì„œë²„ ì˜¤ë¥˜').slice(0, 80));
    }
  }

  function clampIndex(i, n) { if (n <= 0) return 0; return (i % n + n) % n; }

  function renderHeader(title, hint) {
    return `<div class="titleRow"><h1>${title}</h1><div class="hint">${hint || ''}</div></div>`;
  }

  function normalizeRankingItem(x) {
    const title = safeText(x?.title || x?.track || x?.name || x?.[0] || '');
    const score = x?.votes ?? x?.score ?? x?.count ?? x?.[1] ?? '';
    const artist = safeText(x?.artist || x?.by || x?.[2] || '');
    const cover_url = pickCoverUrl(x);
    return { title, artist, score, cover_url };
  }

  function fmtDur(sec) {
    sec = Number(sec || 0);
    const m = Math.floor(sec / 60);
    const s = sec - m * 60;
    return `${m}:${String(s).padStart(2, '0')}`;
  }

  function render() {
    el.pill.textContent = state.online ? 'ONLINE' : 'OFFLINE';
    el.pill.style.opacity = state.online ? '1' : '0.75';

    if (state.page === 'detail') return renderDetail();
    if (state.page === 'menu') return renderMenu();
    if (state.page === 'tracks') return renderTracks();
    if (state.page === 'ranking') return renderRanking();
    if (state.page === 'hot') return renderHot();
    if (state.page === 'runs') return renderRuns();
    if (state.page === 'settings') return renderSettings();
    if (state.page === 'about') return renderAbout();

    state.page = 'menu';
    renderMenu();
  }

  function renderMenu() {
    state.menuIndex = clampIndex(state.menuIndex, MENU.length);
    const items = MENU.map((m, idx) => `
      <div class="item ${idx === state.menuIndex ? 'active' : ''}">
        <div class="thumb">âŒ</div>
        <div class="meta"><div class="name">${m.label}</div><div class="sub">${m.hint}</div></div>
        <div class="right">â€º</div>
      </div>
    `).join('');

    el.view.innerHTML = `
      ${renderHeader('RunnerSheep', 'iPod UI')}
      <div class="list">${items}</div>
      <div class="kbd">ì¡°ì‘: <code>â†‘</code><code>â†“</code> ì´ë™ Â· <code>Enter</code> ì„ íƒ Â· <code>Esc</code> ë’¤ë¡œ Â· <code>Space</code> ì²´í¬</div>
    `;
  }

  function renderTracks() {
    const list = state.tracks || [];
    state.listIndex = clampIndex(state.listIndex, list.length);

    const items = list.map((t, idx) => {
      const cover = pickCoverUrl(t);
      const name = safeText(t.title || t.name || t.track || `Track ${t.id ?? ''}`);
      const artist = safeText(t.artist || t.singer || t.by || '');
      const checked = state.checkedTrackIds.has(Number(t.id));
      return `
        <div class="item ${idx === state.listIndex ? 'active' : ''}">
          <div class="thumb">${cover ? `<img alt="" src="${cover}">` : 'â™ª'}</div>
          <div class="meta"><div class="name">${escapeHtml(name)}</div><div class="sub">${escapeHtml(artist || ' ')}</div></div>
          <div class="right">${checked ? 'âœ“' : '+'}</div>
        </div>
      `;
    }).join('');

    el.view.innerHTML = `
      ${renderHeader('Tracks', 'Space=ì²´í¬')}
      <div class="list">${items || '<div class="item"><div class="thumb">!</div><div class="meta"><div class="name">íŠ¸ë™ì´ ì—†ì–´</div><div class="sub">/api/tracks í™•ì¸</div></div></div>'}</div>
      <div class="kbd"><code>Enter</code> ìƒì„¸ Â· <code>Space</code> ì²´í¬/í•´ì œ Â· <code>Esc</code> ë©”ë‰´</div>
    `;
  }

  function renderRanking() {
    const list = (state.ranking || []).map(normalizeRankingItem);
    state.listIndex = clampIndex(state.listIndex, list.length);

    const items = list.map((r, idx) => `
      <div class="item ${idx === state.listIndex ? 'active' : ''}">
        <div class="thumb">${r.cover_url ? `<img alt="" src="${r.cover_url}">` : String(idx + 1)}</div>
        <div class="meta"><div class="name">${escapeHtml(r.title || 'â€”')}</div><div class="sub">${escapeHtml(r.artist || ' ')}</div></div>
        <div class="right">${escapeHtml(String(r.score))}</div>
      </div>
    `).join('');

    el.view.innerHTML = `
      ${renderHeader('Ranking', 'ì „ì²´')}
      <div class="list">${items || '<div class="item"><div class="thumb">â€¦</div><div class="meta"><div class="name">ë°ì´í„° ì—†ìŒ</div><div class="sub">ì¶”ì²œì„ ë¨¼ì € í•´ë´</div></div></div>'}</div>
      <div class="kbd"><code>Esc</code> ë©”ë‰´</div>
    `;
  }

  function renderHot() {
    const list = (state.hot || []).map(normalizeRankingItem);
    state.listIndex = clampIndex(state.listIndex, list.length);

    const items = list.map((r, idx) => `
      <div class="item ${idx === state.listIndex ? 'active' : ''}">
        <div class="thumb">${r.cover_url ? `<img alt="" src="${r.cover_url}">` : 'ğŸ”¥'}</div>
        <div class="meta"><div class="name">${escapeHtml(r.title || 'â€”')}</div><div class="sub">${escapeHtml(r.artist || ' ')}</div></div>
        <div class="right">${escapeHtml(String(r.score))}</div>
      </div>
    `).join('');

    el.view.innerHTML = `
      ${renderHeader('Hot', 'ìµœê·¼')}
      <div class="list">${items || '<div class="item"><div class="thumb">â€¦</div><div class="meta"><div class="name">ë°ì´í„° ì—†ìŒ</div><div class="sub">ìµœê·¼ ì¶”ì²œì´ ì—†ì–´</div></div></div>'}</div>
      <div class="kbd"><code>Esc</code> ë©”ë‰´</div>
    `;
  }

  function renderRuns() {
    const runs = state.runs || [];
    state.listIndex = clampIndex(state.listIndex, runs.length);

    const items = runs.map((r, idx) => {
      const tracks = Array.isArray(r.tracks) ? r.tracks : [];
      const t0 = tracks[0] || r.track;
      const cover = pickCoverUrl(r.photo_url ? { cover_url: r.photo_url } : t0);
      const baseTitle = t0 ? `${t0.title}` : 'â€”';
      const title = tracks.length > 1 ? `${baseTitle} (+${tracks.length - 1})` : baseTitle;
      const sub = `${r.date_label} Â· ${r.distance_km}km Â· ${fmtDur(r.duration_sec)} Â· ${r.pace}`;
      return `
        <div class="item ${idx === state.listIndex ? 'active' : ''}">
          <div class="thumb">${r.photo_url ? `<img alt="" src="${r.photo_url}">` : (cover ? `<img alt="" src="${cover}">` : 'ğŸƒ')}</div>
          <div class="meta"><div class="name">${escapeHtml(title)}</div><div class="sub">${escapeHtml(sub)}</div></div>
          <div class="right">â€º</div>
        </div>
      `;
    }).join('');

    el.view.innerHTML = `
      ${renderHeader('Runs', 'ì„¼í„°=ìƒˆ ê¸°ë¡')}
      <div class="list">${items || '<div class="item"><div class="thumb">ğŸƒ</div><div class="meta"><div class="name">ê¸°ë¡ ì—†ìŒ</div><div class="sub">ì„¼í„°(SELECT)ë¡œ ì²« ê¸°ë¡ ì¶”ê°€</div></div></div>'}</div>
      <div class="kbd"><code>Esc</code> ë©”ë‰´</div>
    `;
  }

  function renderSettings() {
    const nick = getNick();
    const spClientId = getSpotifyClientId();
    const spConnected = !!getSpotifyToken();

    el.view.innerHTML = `
      ${renderHeader('Settings', 'ë‹‰ë„¤ì„')}
      <div class="detail">
        <div style="display:flex; gap:8px; align-items:center;">
          <input id="nickInput" value="${escapeAttr(nick)}" placeholder="ì˜ˆ) joon" style="flex:1;">
          <button class="btn primary" id="saveNick">ì €ì¥</button>
        </div>

        <div class="cta">
          <button class="btn" id="refreshBtn">ìƒˆë¡œê³ ì¹¨</button>
          <button class="btn" id="loadRuns">ë‚´ Runs</button>
        </div>

        <div style="margin-top:10px; padding-top:10px; border-top:1px solid rgba(255,255,255,.10);"></div>

        <div style="display:flex; gap:8px; align-items:center;">
          <input id="spClientId" value="${escapeAttr(spClientId)}" placeholder="Spotify Client ID" style="flex:1;" />
          <button class="btn primary" id="spSave">ì €ì¥</button>
        </div>

        <div class="cta">
          <button class="btn ${spConnected ? 'primary' : ''}" id="spConnect">${spConnected ? 'ì—°ë™ë¨(ë‹¤ì‹œ)' : 'Spotify ì—°ë™'}</button>
          <button class="btn" id="spDisconnect">ì—°ë™ í•´ì œ</button>
        </div>
      </div>
      <div class="kbd"><code>Esc</code> ë©”ë‰´</div>
    `;

    document.getElementById('saveNick').addEventListener('click', () => {
      const v = document.getElementById('nickInput').value.trim();
      setNick(v);
      showToast('ì €ì¥ë¨', v ? `ë‹‰ë„¤ì„: ${v}` : 'ë¹„ì›Œë’€ì–´');
      render();
    });

    document.getElementById('refreshBtn').addEventListener('click', async () => {
      showToast('ê°±ì‹ ', 'ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦');
      await refreshAll();
    });

    document.getElementById('loadRuns').addEventListener('click', async () => {
      state.page = 'runs';
      await refreshRuns();
    });

    document.getElementById('spSave').addEventListener('click', () => {
      setSpotifyClientId(document.getElementById('spClientId').value.trim());
      showToast('Spotify', 'Client ID ì €ì¥ë¨');
    });
    document.getElementById('spConnect').addEventListener('click', () => spotifyLogin());
    document.getElementById('spDisconnect').addEventListener('click', () => {
      setSpotifyToken('');
      localStorage.removeItem('runrank_spotify_verifier');
      localStorage.removeItem('runrank_spotify_oauth_state');
      showToast('Spotify', 'ì—°ë™ í•´ì œ');
      render();
    });
  }

  function renderAbout() {
    el.view.innerHTML = `
      ${renderHeader('About', 'RunRank')}
      <div class="detail">
        <div style="font-weight:900;">ì´ë²ˆ ì—…ë°ì´íŠ¸</div>
        <div style="font-size:11px; color: var(--muted); line-height:1.45;">
          âœ… ì•¨ë²”ì»¤ë²„: ì„œë²„ ìºì‹œ + iTunes ê²€ìƒ‰<br/>
          âœ… Runs: ëŸ°ë‹ ê¸°ë¡ + ì‚¬ì§„ ì—…ë¡œë“œ<br/>
        </div>
      </div>
      <div class="kbd"><code>Esc</code> ë©”ë‰´</div>
    `;
  }

  function renderDetail() {
    const t = state.selectedTrack;
    if (!t) { state.page = 'tracks'; return renderTracks(); }

    const cover = pickCoverUrl(t);
    const name = safeText(t.title || t.name || t.track || `Track ${t.id ?? ''}`);
    const artist = safeText(t.artist || t.singer || t.by || '');
    const id = t.id ?? t.track_id ?? t.trackId;

    el.view.innerHTML = `
      ${renderHeader('Track', 'ìƒì„¸')}
      <div class="detail">
        <div style="display:flex; gap:10px; align-items:center;">
          <div class="thumb" style="width:56px;height:56px;border-radius:12px;">
            ${cover ? `<img alt="" src="${cover}">` : 'â™ª'}
          </div>
          <div style="min-width:0;">
            <div style="font-weight:900; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${escapeHtml(name)}</div>
            <div style="font-size:11px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${escapeHtml(artist || ' ')}</div>
          </div>
        </div>

        <div class="cta">
          <button class="btn" id="backBtn">ë’¤ë¡œ</button>
          <button class="btn primary" id="voteBtn">ì¶”ì²œ(Like)</button>
        </div>
      </div>
      <div class="kbd"><code>Space</code> ì²´í¬ Â· <code>Esc</code> ë’¤ë¡œ</div>
    `;

    document.getElementById('backBtn').addEventListener('click', () => goBack());
    document.getElementById('voteBtn').addEventListener('click', () => submit(id));
  }

  function goTo(page) { state.page = page; state.listIndex = 0; render(); }
  function goBack() {
    if (state.page === 'detail') { state.page = 'tracks'; return render(); }
    state.page = 'menu'; render();
  }
  function moveUp(){ if (state.page === 'menu') state.menuIndex--; else state.listIndex--; render(); }
  function moveDown(){ if (state.page === 'menu') state.menuIndex++; else state.listIndex++; render(); }

  function select(){
    if (state.page === 'menu'){
      const key = MENU[clampIndex(state.menuIndex, MENU.length)]?.key;
      if (key === 'runs') { state.page = 'runs'; refreshRuns(); return; }
      return goTo(key || 'tracks');
    }
    if (state.page === 'tracks'){
      const list = state.tracks || [];
      const t = list[clampIndex(state.listIndex, list.length)];
      if (!t) return;
      state.selectedTrack = t;
      state.page = 'detail';
      return render();
    }
  }

  function toggleCheck() {
    let id = null;
    if (state.page === 'tracks') {
      const list = state.tracks || [];
      const t = list[clampIndex(state.listIndex, list.length)];
      id = t?.id ?? t?.track_id ?? t?.trackId;
    } else if (state.page === 'detail') {
      id = state.selectedTrack?.id ?? state.selectedTrack?.track_id ?? state.selectedTrack?.trackId;
    }
    if (id == null) return;
    id = Number(id);

    if (state.checkedTrackIds.has(id)) {
      state.checkedTrackIds.delete(id);
      showToast('í•´ì œ', `ì„ íƒê³¡ ${state.checkedTrackIds.size}ê°œ`);
    } else {
      state.checkedTrackIds.add(id);
      showToast('ì²´í¬', `ì„ íƒê³¡ ${state.checkedTrackIds.size}ê°œ`);
    }
    render();
  }

  function attachClickWheelRotation() {
    const wheel = document.querySelector('.wheel');
    const center = document.getElementById('btnCenter');
    if (!wheel || !center) return;
    if (wheel.dataset.bound === '1') return;
    wheel.dataset.bound = '1';

    let dragging = false;
    let lastAngle = 0;
    let accum = 0;
    const STEP_DEG = 22;

    function angleFromEvent(ev) {
      const r = wheel.getBoundingClientRect();
      const cx = r.left + r.width / 2;
      const cy = r.top + r.height / 2;
      const x = ev.clientX - cx;
      const y = ev.clientY - cy;
      let a = Math.atan2(y, x) * 180 / Math.PI;
      if (a < 0) a += 360;
      return a;
    }
    function isOnOuterRing(ev) {
      const r = wheel.getBoundingClientRect();
      const cx = r.left + r.width / 2;
      const cy = r.top + r.height / 2;
      const dx = ev.clientX - cx;
      const dy = ev.clientY - cy;
      const dist = Math.sqrt(dx * dx + dy * dy);
      const outer = r.width / 2;
      const inner = outer * 0.33;
      return dist <= outer && dist >= inner;
    }

    function rotateStep(dir) {
      if (state.page === 'menu') {
        state.menuIndex = clampIndex(state.menuIndex + dir, MENU.length);
        render(); return;
      }
      const listLen =
        state.page === 'tracks' ? (state.tracks || []).length :
        state.page === 'ranking' ? (state.ranking || []).length :
        state.page === 'hot' ? (state.hot || []).length :
        state.page === 'runs' ? (state.runs || []).length : 0;

      if (listLen > 0) {
        state.listIndex = clampIndex(state.listIndex + dir, listLen);
        render();
      }
    }

    wheel.addEventListener('pointerdown', (ev) => {
      if (ev.target === center || center.contains(ev.target)) return;
      if (!isOnOuterRing(ev)) return;
      dragging = true;
      lastAngle = angleFromEvent(ev);
      accum = 0;
      wheel.setPointerCapture(ev.pointerId);
    });

    wheel.addEventListener('pointermove', (ev) => {
      if (!dragging) return;
      if (!isOnOuterRing(ev)) return;
      const a = angleFromEvent(ev);
      let delta = a - lastAngle;
      if (delta > 180) delta -= 360;
      if (delta < -180) delta += 360;
      lastAngle = a;
      accum += delta;
      while (accum >= STEP_DEG) { rotateStep(+1); accum -= STEP_DEG; }
      while (accum <= -STEP_DEG) { rotateStep(-1); accum += STEP_DEG; }
    });

    wheel.addEventListener('pointerup', () => { dragging = false; });
    wheel.addEventListener('pointercancel', () => { dragging = false; });
  }

  function bind() {
    el.btnMenu.addEventListener('click', goBack);
    el.btnPrev.addEventListener('click', moveUp);
    el.btnNext.addEventListener('click', moveDown);
    el.btnCenter.addEventListener('click', select);
    el.btnPlay.addEventListener('click', toggleCheck);

    attachClickWheelRotation();

    window.addEventListener('keydown', (e) => {
      const k = e.key;
      if (k === 'ArrowUp') { e.preventDefault(); moveUp(); }
      else if (k === 'ArrowDown') { e.preventDefault(); moveDown(); }
      else if (k === 'Enter') { e.preventDefault(); select(); }
      else if (k === 'Escape') { e.preventDefault(); goBack(); }
      else if (k === ' ') { e.preventDefault(); toggleCheck(); }
    });

    window.addEventListener('online', () => setTimeout(checkOnline, 300));
    window.addEventListener('offline', () => setTimeout(checkOnline, 300));
  }

  function tick() { el.clock.textContent = fmtClock(); }

  // boot
  bind();
  tick();
  setInterval(tick, 1000 * 10);
  handleSpotifyCallback();

  window.addEventListener('load', () => {
    startOnlineMonitor();
    refreshAll();
  });
})();
</script>
</body>
</html>
