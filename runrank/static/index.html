<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>RunRank</title>

  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#0f0f12">

  <style>
    :root{
      --bg:#0b0b0f;
      --device:#e9e9ee;
      --device2:#d7d7de;
      --shadow: rgba(0,0,0,.35);
      --screen:#0f1620;
      --screen2:#121b27;
      --text:#eaf0ff;
      --muted:#9db0d6;
      --accent:#62a7ff;
      --accent2:#8a5cff;
      --good:#4ade80;
      --bad:#fb7185;
      --ring: rgba(98,167,255,.35);
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Apple SD Gothic Neo", "Noto Sans KR", Arial;
      background: radial-gradient(900px 600px at 50% 20%, #1a2740 0%, #0b0b0f 60%);
      color: var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px;
    }
    .wrap{
      width:min(980px, 100%);
      display:grid;
      grid-template-columns: 1fr;
      gap: 16px;
      align-items:start;
      justify-items:center;
    }
    .topbar{
      width:min(980px, 100%);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      opacity:.95;
    }
    .brand{ display:flex; align-items:center; gap:10px; font-weight:700; letter-spacing:.2px; }
    .dot{
      width:10px; height:10px; border-radius:50%;
      background: var(--good);
      box-shadow:0 0 0 5px rgba(74,222,128,.15);
    }
    .pill{
      border:1px solid rgba(255,255,255,.12);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      color: var(--muted);
      background: rgba(0,0,0,.25);
      backdrop-filter: blur(6px);
      display:flex; align-items:center; gap:8px;
    }
    .pill b{ color: var(--text); font-weight:600; }

    .device{
      width:min(430px, 100%);
      aspect-ratio: 9 / 16;
      background: linear-gradient(180deg, var(--device) 0%, var(--device2) 100%);
      border-radius: 42px;
      box-shadow:
        0 40px 80px var(--shadow),
        0 6px 0 rgba(255,255,255,.55) inset,
        0 -10px 20px rgba(0,0,0,.10) inset;
      padding: 18px;
      position:relative;
      overflow:hidden;
    }
    .device::before{
      content:"";
      position:absolute;
      inset:-120px -160px auto auto;
      width:360px; height:360px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.65), rgba(255,255,255,0) 60%);
      transform: rotate(10deg);
      opacity:.4;
      pointer-events:none;
    }
    .speaker{
      position:absolute; top:14px; left:50%;
      transform:translateX(-50%);
      width: 110px; height: 8px;
      border-radius: 999px;
      background: rgba(0,0,0,.18);
      box-shadow: 0 2px 0 rgba(255,255,255,.4) inset;
    }
    .screen{
      width:100%;
      height: 48%;
      background: linear-gradient(180deg, var(--screen) 0%, var(--screen2) 100%);
      border-radius: 26px;
      box-shadow:
        0 10px 30px rgba(0,0,0,.25),
        0 0 0 1px rgba(255,255,255,.10) inset;
      padding: 14px;
      overflow:hidden;
      position:relative;
    }
    .screen::after{
      content:"";
      position:absolute;
      inset:0;
      background: radial-gradient(800px 300px at 50% -40%, rgba(98,167,255,.25), rgba(0,0,0,0) 55%);
      pointer-events:none;
    }

    /* âœ… í•µì‹¬: viewë¥¼ í™”ë©´ ë†’ì´ 100%ë¡œ ê³ ì • + flex column */
    #view{
      height:100%;
      display:flex;
      flex-direction:column;
      min-height:0; /* flex overflow ë²„ê·¸ ë°©ì§€ */
      position:relative;
      z-index:1;
    }

    .titleRow{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      margin-bottom: 10px;
    }
    .titleRow h1{
      margin:0;
      font-size: 16px;
      letter-spacing:.2px;
      font-weight:800;
    }
    .hint{
      font-size:12px;
      color: var(--muted);
      border:1px solid rgba(255,255,255,.10);
      padding:4px 8px;
      border-radius:999px;
      background: rgba(0,0,0,.18);
    }

    /* âœ… í•µì‹¬: listë¥¼ flex:1ë¡œ ë§Œë“¤ì–´ í•­ìƒ ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ê²Œ */
    .list{
      flex:1;
      min-height:0;
      border-radius: 16px;
      overflow:auto;
      padding: 6px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.09);
      scroll-behavior: auto;
      -webkit-overflow-scrolling: touch;
    }

    .item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 10px 12px;
      border-radius: 14px;
      color: var(--text);
      cursor: default;
      user-select:none;
    }
    .item + .item{ margin-top: 6px; }
    .item .meta{ display:flex; flex-direction:column; gap:2px; min-width:0; }
    .item .name{ font-weight:700; font-size: 14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .item .sub{ font-size: 12px; color: var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .item .right{ color: rgba(255,255,255,.55); font-weight:900; }
    .item.active{
      background: linear-gradient(135deg, rgba(98,167,255,.35), rgba(138,92,255,.25));
      box-shadow: 0 0 0 2px var(--ring) inset, 0 10px 22px rgba(0,0,0,.25);
    }

    .thumb{
      width: 34px; height: 34px;
      border-radius: 10px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      display:flex; align-items:center; justify-content:center;
      overflow:hidden;
      flex: 0 0 auto;
    }
    .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }

    .kbd{
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.5;
    }
    .kbd code{
      background: rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.10);
      padding: 2px 6px;
      border-radius: 8px;
      color: var(--text);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      margin: 0 2px;
    }

    .wheel{
      width:100%;
      height: calc(52% - 18px);
      margin-top: 18px;
      background: linear-gradient(180deg, rgba(255,255,255,.65), rgba(255,255,255,.30));
      border-radius: 28px;
      box-shadow:
        0 10px 28px rgba(0,0,0,.22),
        0 0 0 1px rgba(255,255,255,.65) inset,
        0 -12px 20px rgba(0,0,0,.08) inset;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      touch-action: none;
      user-select:none;
      -webkit-user-select:none;
      -webkit-touch-callout:none;
    }
    .ring{
      width: 76%;
      height: 76%;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, rgba(0,0,0,.06), rgba(0,0,0,0) 60%);
      box-shadow:
        0 0 0 1px rgba(0,0,0,.15) inset,
        0 6px 16px rgba(0,0,0,.12) inset;
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .center{
      width: 46%;
      height: 46%;
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,255,255,.55));
      box-shadow:
        0 8px 22px rgba(0,0,0,.16),
        0 0 0 1px rgba(0,0,0,.12) inset;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      color:#111;
      letter-spacing:.6px;
      cursor:pointer;
      transition: transform .08s ease;
      z-index:3;
    }
    .center:active{ transform: scale(.98); }

    .btnLabel{
      position:absolute;
      font-size: 12px;
      font-weight: 800;
      letter-spacing:.4px;
      color: rgba(0,0,0,.72);
      text-transform: uppercase;
      pointer-events:none;
      z-index:2;
    }
    .btnLabel.menu{ top: 12px; }
    .btnLabel.play{ right: 12px; }
    .btnLabel.back{ left: 12px; }
    .btnLabel.next{ bottom: 12px; }

    /* âœ… í•µì‹¬: í°ì—ì„œ ëˆ„ë¥¼ ìˆ˜ ìˆëŠ” hit area */
    .hit{
      position:absolute;
      width: 44%;
      height: 22%;
      border-radius: 999px;
      background: rgba(0,0,0,0);
      z-index:4;
      pointer-events:auto;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .hit.menu{ top: 0; left: 50%; transform: translateX(-50%); }
    .hit.next{ bottom: 0; left: 50%; transform: translateX(-50%); }
    .hit.back{ left: 0; top: 50%; transform: translateY(-50%); width:22%; height:44%; }
    .hit.play{ right: 0; top: 50%; transform: translateY(-50%); width:22%; height:44%; }

    .tapHint{
      position:absolute;
      bottom: 8px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 11px;
      color: rgba(0,0,0,.55);
      pointer-events:none;
    }

    .detail{
      flex:1;
      min-height:0;
      border-radius: 16px;
      padding: 12px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.09);
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    .detail h2{ margin: 4px 0 6px; font-size: 15px; }
    .detail p{ margin: 6px 0; color: var(--muted); font-size: 12px; line-height: 1.5; }
    .detail .row{ display:flex; gap:10px; align-items:center; }
    .detail .cover{
      width: 64px; height: 64px; border-radius: 14px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
      flex:0 0 auto;
      display:flex; align-items:center; justify-content:center;
      font-weight: 900;
    }
    .detail .cover img{ width:100%; height:100%; object-fit:cover; display:block; }
    .chipRow{ display:flex; flex-wrap:wrap; gap:6px; margin-top: 10px; }
    .chip{
      border:1px solid rgba(255,255,255,.10);
      padding: 5px 8px;
      border-radius: 999px;
      font-size: 11px;
      color: var(--muted);
      background: rgba(0,0,0,.20);
    }
    .chip b{ color: var(--text); font-weight:700; }

    @media (min-width: 820px){
      .wrap{ grid-template-columns: 1fr 1fr; }
      .device{ justify-self:end; }
      .topbar{ grid-column: 1 / -1; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <span class="dot" id="dot"></span>
        <span>RunRank</span>
      </div>
      <div class="pill"><b id="pill">OFFLINE</b><span>Â· PWA</span></div>
    </div>

    <div class="device" id="device">
      <div class="speaker"></div>

      <div class="screen" id="screen">
        <div id="view"></div>
      </div>

      <div class="wheel" id="wheel">
        <div class="ring" id="ring">
          <div class="btnLabel menu">MENU</div>
          <div class="btnLabel back">BACK</div>
          <div class="btnLabel play">PLAY</div>
          <div class="btnLabel next">NEXT</div>

          <!-- âœ… í° í„°ì¹˜ìš© hit areas -->
          <div class="hit menu" id="btnMenu" aria-label="Menu"></div>
          <div class="hit back" id="btnBack" aria-label="Back"></div>
          <div class="hit play" id="btnPlay" aria-label="Play"></div>
          <div class="hit next" id="btnNext" aria-label="Next"></div>

          <div class="center" id="center">OK</div>
          <div class="tapHint">íœ : ë“œë˜ê·¸ / ë§ˆìš°ìŠ¤íœ  / í„°ì¹˜</div>
        </div>
      </div>
    </div>

    <div style="width:min(430px, 100%); opacity:.9; color:var(--muted); font-size:12px; line-height:1.55">
      <div style="font-weight:800; color:var(--text); margin-bottom:6px;">ì‚¬ìš©ë²•</div>
      <div>Â· íœ  íšŒì „: ë©”ë‰´/ë¦¬ìŠ¤íŠ¸ ì´ë™</div>
      <div>Â· OK(ì„¼í„°): ì„ íƒ / ìƒì„¸ / ì €ì¥</div>
      <div>Â· MENU: ë©”ì¸ ë©”ë‰´</div>
      <div>Â· BACK: ì´ì „ í™”ë©´</div>
    </div>
  </div>

  <script>
  // ===== PWA / SW =====
  (function(){
    const dot = document.getElementById('dot');
    const pill = document.getElementById('pill');

    function setOnline(yes){
      dot.style.background = yes ? 'var(--good)' : 'var(--bad)';
      dot.style.boxShadow = yes ? '0 0 0 5px rgba(74,222,128,.15)' : '0 0 0 5px rgba(251,113,133,.15)';
      pill.textContent = yes ? 'ONLINE' : 'OFFLINE';
    }
    setOnline(navigator.onLine);
    window.addEventListener('online', ()=>setOnline(true));
    window.addEventListener('offline', ()=>setOnline(false));

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js').catch(()=>{});
      });
    }
  })();

  // ===== App State =====
  const el = {
    view: document.getElementById('view'),
    wheel: document.getElementById('wheel'),
    ring: document.getElementById('ring'),
    center: document.getElementById('center'),
    pill: document.getElementById('pill'),

    btnMenu: document.getElementById('btnMenu'),
    btnBack: document.getElementById('btnBack'),
    btnPlay: document.getElementById('btnPlay'),
    btnNext: document.getElementById('btnNext'),
  };

  const MENU = [
    { key:'tracks',  label:'Tracks',  hint:'ë…¸ë˜ ë¦¬ìŠ¤íŠ¸' },
    { key:'ranking', label:'Ranking', hint:'íˆ¬í‘œ ë­í‚¹' },
    { key:'hot',     label:'Hot',     hint:'ìµœê·¼ íŠ¸ë Œë“œ' },
    { key:'runs',    label:'Runs',    hint:'ëŸ°ë‹ ê¸°ë¡' },
    { key:'settings',label:'Settings',hint:'ì„¤ì •' },
    { key:'about',   label:'About',   hint:'ì •ë³´' },
  ];

  const state = {
    online: navigator.onLine,
    page: 'menu',
    menuIndex: 0,
    listIndex: 0,
    detailItem: null, // {type, data, from}
    tracks: [],
    ranking: [],
    hot: [],
    runs: [],
    checkedTrackIds: new Set(),
  };

  function safeText(s){
    return String(s ?? '').replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
  }
  function clampIndex(i, n) { if (n <= 0) return 0; return Math.max(0, Math.min(n - 1, i)); }
  function modIndex(i, n) { if (n <= 0) return 0; return (i % n + n) % n; }

  function renderHeader(title, hint) {
    return `<div class="titleRow"><h1>${title}</h1><div class="hint">${hint || ''}</div></div>`;
  }

  // âœ… í•µì‹¬: activeê°€ ë³´ì´ê²Œ ê°•ì œë¡œ ë§ì¶¤ (ìŠ¤í¬ë¡¤/ë†’ì´ ë¬¸ì œê¹Œì§€ ê°™ì´ í•´ê²°)
  function ensureActiveInView() {
    const active = el.view.querySelector('.item.active');
    if (!active) return;
    active.scrollIntoView({ block: 'nearest' });
  }

  function pickCoverUrl(obj){
    if(!obj) return '';
    const c = obj.cover_url || obj.cover || obj.image || obj.album_cover || obj.artwork || obj.artwork_url || '';
    if (typeof c === 'string') return c;
    if (c && typeof c === 'object') return c.url || c.small || c.medium || c.large || '';
    return '';
  }

  function normalizeRankingItem(x) {
    const title = safeText(x?.title || x?.track || x?.name || x?.[0] || '');
    const score = x?.votes ?? x?.score ?? x?.count ?? x?.[1] ?? '';
    const artist = safeText(x?.artist || x?.by || x?.[2] || '');
    const cover_url = pickCoverUrl(x);
    return { title, artist, score, cover_url };
  }

  function fmtDur(sec) {
    sec = Number(sec || 0);
    const m = Math.floor(sec / 60);
    const s = sec - m * 60;
    return `${m}:${String(s).padStart(2, '0')}`;
  }

  function render() {
    el.pill.textContent = state.online ? 'ONLINE' : 'OFFLINE';

    if (state.page === 'detail') return renderDetail();
    if (state.page === 'menu') return renderMenu();
    if (state.page === 'tracks') return renderTracks();
    if (state.page === 'ranking') return renderRanking();
    if (state.page === 'hot') return renderHot();
    if (state.page === 'runs') return renderRuns();
    if (state.page === 'settings') return renderSettings();
    if (state.page === 'about') return renderAbout();

    state.page = 'menu';
    renderMenu();
  }

  function renderMenu() {
    state.menuIndex = clampIndex(state.menuIndex, MENU.length);
    const items = MENU.map((m, idx) => `
      <div class="item ${idx === state.menuIndex ? 'active' : ''}">
        <div class="thumb">âŒ</div>
        <div class="meta"><div class="name">${m.label}</div><div class="sub">${m.hint}</div></div>
        <div class="right">â€º</div>
      </div>
    `).join('');

    el.view.innerHTML = `
      ${renderHeader('RunnerSheep', 'iPod UI')}
      <div class="list">${items}</div>
      <div class="kbd">íœ /â†‘â†“ ì´ë™ Â· OK ì„ íƒ Â· MENU ë©”ì¸ Â· BACK ë’¤ë¡œ</div>
    `;
    requestAnimationFrame(ensureActiveInView);
  }

  function renderTracks() {
    const list = state.tracks || [];
    state.listIndex = clampIndex(state.listIndex, list.length);

    const items = list.map((t, idx) => {
      const cover = pickCoverUrl(t);
      const name = safeText(t.title || t.name || t.track || `Track ${t.id ?? ''}`);
      const artist = safeText(t.artist || t.singer || t.by || '');
      const checked = state.checkedTrackIds.has(Number(t.id));
      return `
        <div class="item ${idx === state.listIndex ? 'active' : ''}">
          <div class="thumb">${cover ? `<img src="${cover}" alt="">` : 'â™ª'}</div>
          <div class="meta">
            <div class="name">${name}</div>
            <div class="sub">${artist}</div>
          </div>
          <div class="right">${checked ? 'âœ“' : 'â€º'}</div>
        </div>
      `;
    }).join('');

    el.view.innerHTML = `
      ${renderHeader('Tracks', 'Space=ì²´í¬')}
      <div class="list">${items || '<div class="item"><div class="thumb">!</div><div class="meta"><div class="name">íŠ¸ë™ì´ ì—†ì–´</div><div class="sub">tracks.json í™•ì¸</div></div><div class="right"></div></div>'}</div>
      <div class="kbd">íœ /â†‘â†“ ì´ë™ Â· Space ì²´í¬ Â· OK ìƒì„¸ Â· BACK ë’¤ë¡œ</div>
    `;
    requestAnimationFrame(ensureActiveInView);
  }

  function renderRanking() {
    const list = state.ranking || [];
    state.listIndex = clampIndex(state.listIndex, list.length);

    const items = list.map((x, idx) => {
      const it = normalizeRankingItem(x);
      return `
        <div class="item ${idx === state.listIndex ? 'active' : ''}">
          <div class="thumb">${it.cover_url ? `<img src="${it.cover_url}" alt="">` : 'â˜…'}</div>
          <div class="meta">
            <div class="name">${it.title || '(ì œëª© ì—†ìŒ)'}</div>
            <div class="sub">${it.artist ? `${it.artist}` : ''}${it.score !== '' ? ` Â· ${it.score}` : ''}</div>
          </div>
          <div class="right">â€º</div>
        </div>
      `;
    }).join('');

    el.view.innerHTML = `
      ${renderHeader('Ranking', 'ì „ì²´')}
      <div class="list">${items || '<div class="item"><div class="thumb">â€¦</div><div class="meta"><div class="name">ë°ì´í„° ì—†ìŒ</div><div class="sub">ì•„ì§ íˆ¬í‘œê°€ ì—†ì–´</div></div><div class="right"></div></div>'}</div>
      <div class="kbd">íœ /â†‘â†“ ì´ë™ Â· OK ìƒì„¸ Â· BACK ë’¤ë¡œ</div>
    `;
    requestAnimationFrame(ensureActiveInView);
  }

  function renderHot() {
    const list = state.hot || [];
    state.listIndex = clampIndex(state.listIndex, list.length);

    const items = list.map((x, idx) => {
      const it = normalizeRankingItem(x);
      return `
        <div class="item ${idx === state.listIndex ? 'active' : ''}">
          <div class="thumb">${it.cover_url ? `<img src="${it.cover_url}" alt="">` : 'ğŸ”¥'}</div>
          <div class="meta">
            <div class="name">${it.title || '(ì œëª© ì—†ìŒ)'}</div>
            <div class="sub">${it.artist ? `${it.artist}` : ''}${it.score !== '' ? ` Â· ${it.score}` : ''}</div>
          </div>
          <div class="right">â€º</div>
        </div>
      `;
    }).join('');

    el.view.innerHTML = `
      ${renderHeader('Hot', 'ìµœê·¼')}
      <div class="list">${items || '<div class="item"><div class="thumb">â€¦</div><div class="meta"><div class="name">ë°ì´í„° ì—†ìŒ</div><div class="sub">ìµœê·¼ ë°ì´í„°ê°€ ì—†ì–´</div></div><div class="right"></div></div>'}</div>
      <div class="kbd">íœ /â†‘â†“ ì´ë™ Â· OK ìƒì„¸ Â· BACK ë’¤ë¡œ</div>
    `;
    requestAnimationFrame(ensureActiveInView);
  }

  function renderRuns() {
    const list = state.runs || [];
    state.listIndex = clampIndex(state.listIndex, list.length);

    const items = list.map((r, idx) => {
      const dt = safeText(r.date || r.created_at || '');
      const dist = (r.distance_km ?? r.distance ?? '');
      const dur = r.duration_sec ? fmtDur(r.duration_sec) : safeText(r.duration || r.time || '');
      return `
        <div class="item ${idx === state.listIndex ? 'active' : ''}">
          <div class="thumb">ğŸƒ</div>
          <div class="meta">
            <div class="name">${dt || 'Run'}</div>
            <div class="sub">${dist ? `${dist}km` : ''}${dur ? ` Â· ${dur}` : ''}</div>
          </div>
          <div class="right">â€º</div>
        </div>
      `;
    }).join('');

    el.view.innerHTML = `
      ${renderHeader('Runs', 'ê¸°ë¡')}
      <div class="list">${items || '<div class="item"><div class="thumb">ğŸƒ</div><div class="meta"><div class="name">ê¸°ë¡ ì—†ìŒ</div><div class="sub">OKë¡œ ì¶”ê°€(ì¶”í›„)</div></div><div class="right"></div></div>'}</div>
      <div class="kbd">íœ /â†‘â†“ ì´ë™ Â· OK ìƒì„¸ Â· BACK ë’¤ë¡œ</div>
    `;
    requestAnimationFrame(ensureActiveInView);
  }

  function renderSettings() {
    el.view.innerHTML = `
      ${renderHeader('Settings', 'ê°„ë‹¨')}
      <div class="detail">
        <h2>ì„¤ì •</h2>
        <p>Â· Space: Tracksì—ì„œ ì²´í¬/í•´ì œ</p>
        <p>Â· OK: ì„ íƒ/ìƒì„¸</p>
        <p>Â· MENU: ë©”ì¸ ë©”ë‰´</p>
        <p>Â· BACK: ì´ì „ í™”ë©´</p>
        <div class="chipRow">
          <div class="chip"><b>PWA</b> ì˜¤í”„ë¼ì¸ ìºì‹œ</div>
        </div>
      </div>
      <div class="kbd">BACKë¡œ ì´ì „</div>
    `;
  }

  function renderAbout() {
    el.view.innerHTML = `
      ${renderHeader('About', 'RunRank')}
      <div class="detail">
        <h2>RunRank</h2>
        <p>ëŸ¬ë‹ìš© ë…¸ë˜ ì²´í¬/ë­í‚¹/ê¸°ë¡.</p>
        <p>ì„œë²„: FastAPI + SQLite</p>
        <div class="chipRow">
          <div class="chip"><b>API</b> /api/health</div>
          <div class="chip"><b>PWA</b> service-worker</div>
        </div>
      </div>
      <div class="kbd">BACKë¡œ ì´ì „</div>
    `;
  }

  function renderDetail() {
    const d = state.detailItem;
    if (!d) { state.page = 'menu'; return renderMenu(); }

    if (d.type === 'track') {
      const t = d.data || {};
      const cover = pickCoverUrl(t);
      const checked = state.checkedTrackIds.has(Number(t.id));
      el.view.innerHTML = `
        ${renderHeader('Track', checked ? 'âœ“ ì²´í¬ë¨' : '')}
        <div class="detail">
          <div class="row">
            <div class="cover">${cover ? `<img src="${cover}" alt="">` : 'â™ª'}</div>
            <div style="min-width:0">
              <h2>${safeText(t.title || t.name || t.track || 'Untitled')}</h2>
              <p>${safeText(t.artist || t.singer || t.by || '')}</p>
            </div>
          </div>
          <div class="chipRow">
            <div class="chip"><b>ID</b> ${safeText(t.id ?? '')}</div>
            <div class="chip"><b>ì²´í¬</b> Spaceë¡œ í† ê¸€</div>
          </div>
        </div>
        <div class="kbd">Space ì²´í¬ Â· BACK ë’¤ë¡œ Â· MENU ë©”ì¸</div>
      `;
      return;
    }

    if (d.type === 'rank') {
      const it = normalizeRankingItem(d.data || {});
      el.view.innerHTML = `
        ${renderHeader('Detail', 'Ranking')}
        <div class="detail">
          <div class="row">
            <div class="cover">${it.cover_url ? `<img src="${it.cover_url}" alt="">` : 'â˜…'}</div>
            <div style="min-width:0">
              <h2>${it.title || '(ì œëª© ì—†ìŒ)'}</h2>
              <p>${it.artist || ''}</p>
            </div>
          </div>
          <div class="chipRow">
            <div class="chip"><b>ì ìˆ˜</b> ${safeText(it.score)}</div>
          </div>
        </div>
        <div class="kbd">BACK ë’¤ë¡œ</div>
      `;
      return;
    }

    if (d.type === 'run') {
      const r = d.data || {};
      const dt = safeText(r.date || r.created_at || '');
      const dist = (r.distance_km ?? r.distance ?? '');
      const dur = r.duration_sec ? fmtDur(r.duration_sec) : safeText(r.duration || r.time || '');
      el.view.innerHTML = `
        ${renderHeader('Run', 'ê¸°ë¡')}
        <div class="detail">
          <h2>${dt || 'Run'}</h2>
          <div class="chipRow">
            <div class="chip"><b>ê±°ë¦¬</b> ${safeText(dist)} km</div>
            <div class="chip"><b>ì‹œê°„</b> ${dur}</div>
          </div>
        </div>
        <div class="kbd">BACK ë’¤ë¡œ</div>
      `;
      return;
    }

    state.page = 'menu';
    renderMenu();
  }

  // ===== Data Fetch =====
  async function api(path, opts) {
    const res = await fetch(path, opts || {});
    if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
    return await res.json();
  }

  async function loadAll() {
    try {
      state.online = navigator.onLine;
      const [tracks, ranking, hot, runs] = await Promise.all([
        api('/api/tracks').catch(()=>[]),
        api('/api/ranking').catch(()=>[]),
        api('/api/hot').catch(()=>[]),
        api('/api/runs').catch(()=>[]),
      ]);
      state.tracks = Array.isArray(tracks) ? tracks : (tracks.items || []);
      state.ranking = Array.isArray(ranking) ? ranking : (ranking.items || []);
      state.hot = Array.isArray(hot) ? hot : (hot.items || []);
      state.runs = Array.isArray(runs) ? runs : (runs.items || []);
      render();
    } catch (e) {
      state.online = false;
      render();
    }
  }

  // ===== Navigation / Actions =====
  function goMenu() {
    state.page = 'menu';
    state.menuIndex = clampIndex(state.menuIndex, MENU.length);
    state.listIndex = 0;
    state.detailItem = null;
    renderMenu();
  }

  function goBack() {
    if (state.page === 'detail') {
      const from = state.detailItem?.from || 'menu';
      state.page = from;
      state.detailItem = null;
      render();
      return;
    }
    if (state.page !== 'menu') {
      state.page = 'menu';
      state.listIndex = 0;
      renderMenu();
      return;
    }
  }

  function openSelected() {
    if (state.page === 'menu') {
      const m = MENU[state.menuIndex];
      if (!m) return;
      state.page = m.key;
      state.listIndex = 0;
      render();
      return;
    }

    if (state.page === 'tracks') {
      const t = (state.tracks || [])[state.listIndex];
      if (!t) return;
      state.detailItem = { type:'track', data:t, from:'tracks' };
      state.page = 'detail';
      renderDetail();
      return;
    }

    if (state.page === 'ranking') {
      const x = (state.ranking || [])[state.listIndex];
      if (!x) return;
      state.detailItem = { type:'rank', data:x, from:'ranking' };
      state.page = 'detail';
      renderDetail();
      return;
    }

    if (state.page === 'hot') {
      const x = (state.hot || [])[state.listIndex];
      if (!x) return;
      state.detailItem = { type:'rank', data:x, from:'hot' };
      state.page = 'detail';
      renderDetail();
      return;
    }

    if (state.page === 'runs') {
      const r = (state.runs || [])[state.listIndex];
      if (!r) return;
      state.detailItem = { type:'run', data:r, from:'runs' };
      state.page = 'detail';
      renderDetail();
      return;
    }
  }

  function toggleCheckSelected() {
    if (state.page === 'tracks') {
      const t = (state.tracks || [])[state.listIndex];
      if (!t?.id) return;
      const id = Number(t.id);
      if (state.checkedTrackIds.has(id)) state.checkedTrackIds.delete(id);
      else state.checkedTrackIds.add(id);
      renderTracks();
      return;
    }
    if (state.page === 'detail' && state.detailItem?.type === 'track') {
      const t = state.detailItem.data;
      const id = Number(t.id);
      if (state.checkedTrackIds.has(id)) state.checkedTrackIds.delete(id);
      else state.checkedTrackIds.add(id);
      renderDetail();
      return;
    }
  }

  // ===== Keyboard controls =====
  window.addEventListener('keydown', (e)=>{
    const k = e.key.toLowerCase();
    if (k === 'escape') { goBack(); return; }
    if (k === 'm') { goMenu(); return; }
    if (k === 'enter') { openSelected(); return; }
    if (k === ' ') { e.preventDefault(); toggleCheckSelected(); return; }
    if (k === 'arrowup') { moveSelection(-1); return; }
    if (k === 'arrowdown') { moveSelection(+1); return; }
  });

  function moveSelection(delta){
    if (state.page === 'menu') {
      state.menuIndex = modIndex(state.menuIndex + delta, MENU.length);
      renderMenu();
      return;
    }
    if (state.page === 'tracks') {
      const n = (state.tracks || []).length;
      state.listIndex = modIndex(state.listIndex + delta, n);
      renderTracks();
      return;
    }
    if (state.page === 'ranking') {
      const n = (state.ranking || []).length;
      state.listIndex = modIndex(state.listIndex + delta, n);
      renderRanking();
      return;
    }
    if (state.page === 'hot') {
      const n = (state.hot || []).length;
      state.listIndex = modIndex(state.listIndex + delta, n);
      renderHot();
      return;
    }
    if (state.page === 'runs') {
      const n = (state.runs || []).length;
      state.listIndex = modIndex(state.listIndex + delta, n);
      renderRuns();
      return;
    }
  }

  // ===== Click list support =====
  el.view.addEventListener('click', (e)=>{
    const item = e.target.closest('.item');
    if (!item) return;
    const list = Array.from(el.view.querySelectorAll('.item'));
    const idx = list.indexOf(item);
    if (idx < 0) return;

    if (state.page === 'menu') {
      state.menuIndex = idx;
      renderMenu();
      openSelected();
      return;
    }
    if (['tracks','ranking','hot','runs'].includes(state.page)) {
      state.listIndex = idx;
      render();
      openSelected();
      return;
    }
  });

  // ===== Wheel: drag + mousewheel + touch =====
  (function(){
    let dragging = false;
    let lastAngle = 0;
    let accum = 0;
    const STEP = 18;

    function angleFromEvent(ev){
      const rect = el.ring.getBoundingClientRect();
      const cx = rect.left + rect.width/2;
      const cy = rect.top + rect.height/2;
      const p = ev.touches ? ev.touches[0] : ev;
      const x = (p.clientX) - cx;
      const y = (p.clientY) - cy;
      return Math.atan2(y, x) * 180 / Math.PI;
    }

    function onStart(ev){
      dragging = true;
      lastAngle = angleFromEvent(ev);
      accum = 0;
      ev.preventDefault();
    }
    function onMove(ev){
      if (!dragging) return;
      const a = angleFromEvent(ev);
      let diff = a - lastAngle;
      if (diff > 180) diff -= 360;
      if (diff < -180) diff += 360;
      lastAngle = a;
      accum += diff;

      while (accum >= STEP) { accum -= STEP; moveSelection(+1); }
      while (accum <= -STEP) { accum += STEP; moveSelection(-1); }
      ev.preventDefault();
    }
    function onEnd(ev){
      dragging = false;
      ev.preventDefault();
    }

    el.ring.addEventListener('touchstart', onStart, {passive:false});
    el.ring.addEventListener('touchmove', onMove, {passive:false});
    el.ring.addEventListener('touchend', onEnd, {passive:false});

    el.ring.addEventListener('pointerdown', onStart, {passive:false});
    el.ring.addEventListener('pointermove', onMove, {passive:false});
    el.ring.addEventListener('pointerup', onEnd, {passive:false});
    el.ring.addEventListener('pointercancel', onEnd, {passive:false});

    el.wheel.addEventListener('wheel', (e)=>{
      e.preventDefault();
      const d = e.deltaY > 0 ? +1 : -1;
      moveSelection(d);
    }, {passive:false});

    // âœ… OK
    el.center.addEventListener('click', (e)=>{
      e.stopPropagation();
      openSelected();
    });

    // âœ… MENU/BACK/PLAY/NEXT (í° íƒ­ 100% ë™ì‘)
    function bind(btn, fn){
      btn.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); fn(); });
      btn.addEventListener('touchend', (e)=>{ e.preventDefault(); e.stopPropagation(); fn(); }, {passive:false});
    }
    bind(el.btnMenu, goMenu);
    bind(el.btnBack, goBack);

    // play/nextëŠ” ì¼ë‹¨ â€œë¦¬ìŠ¤íŠ¸ ì´ë™â€ìœ¼ë¡œ ë§µí•‘ (ì›í•˜ë©´ ë‹¤ë¥¸ ê¸°ëŠ¥ìœ¼ë¡œ ë°”ê¿”ì¤Œ)
    bind(el.btnPlay, ()=>moveSelection(-1));
    bind(el.btnNext, ()=>moveSelection(+1));
  })();

  // First paint
  render();
  loadAll();
  </script>
</body>
</html>
