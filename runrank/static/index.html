<script>
(() => {
  // ----------------------
  // âœ… Fail-safe: JS ì—ëŸ¬ë¥¼ í™”ë©´ì— ë„ì›Œì„œ "í•˜ì–€ í™”ë©´" ë°©ì§€
  // ----------------------
  function showFatal(err) {
    try {
      const target = document.querySelector('.screen') || document.body;
      const box = document.createElement('div');
      box.style.cssText = `
        position:fixed; inset:8px; padding:10px;
        border-radius:12px; background:rgba(0,0,0,.78);
        border:1px solid rgba(255,255,255,.18);
        color:#fff;
        font:12px/1.45 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        overflow:auto; white-space:pre-wrap;
        z-index:999999;
      `;
      box.textContent = "[JS ERROR]\n" + String(err && (err.stack || err.message || err));
      target.appendChild(box);
    } catch (_) {}
  }
  window.addEventListener('error', (e) => showFatal(e.error || e.message));
  window.addEventListener('unhandledrejection', (e) => showFatal(e.reason));

  // ----------------------
  // âœ… Service Worker: ì •ìƒ ë“±ë¡ + ì—…ë°ì´íŠ¸ ì²´í¬
  // ----------------------
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', async () => {
      try {
        const reg = await navigator.serviceWorker.register('/service-worker.js');
        try { await reg.update(); } catch (_) {}
      } catch (_) {}
    });
  }

  try {
    // ----------------------
    // âœ… State
    // ----------------------
    const state = {
      page: 'menu',   // menu | tracks | ranking | hot | runs | run_new | settings | about | detail
      menuIndex: 0,
      listIndex: 0,
      tracks: [],
      ranking: [],
      hot: [],
      runs: [],
      selectedTrack: null,
      checkedTrackIds: new Set(),
      online: true,
    };

    const MENU = [
      { key: 'tracks',   label: 'Tracks',   hint: 'ê³¡ ëª©ë¡ / ì¶”ì²œ' },
      { key: 'ranking',  label: 'Ranking',  hint: 'ì „ì²´ ë­í‚¹' },
      { key: 'hot',      label: 'Hot',      hint: 'ìµœê·¼ ì¸ê¸°' },
      { key: 'runs',     label: 'Runs',     hint: 'ëŸ°ë‹ ê¸°ë¡ + ì‚¬ì§„' },
      { key: 'settings', label: 'Settings', hint: 'ë‹‰ë„¤ì„ / ì˜µì…˜' },
      { key: 'about',    label: 'About',    hint: 'ì•± ì •ë³´' },
    ];

    // ----------------------
    // âœ… DOM (ì—†ìœ¼ë©´ ì£½ì§€ ì•Šê²Œ)
    // ----------------------
    const el = {
      view: document.getElementById('view'),
      toast: document.getElementById('toast'),
      toastTitle: document.getElementById('toastTitle'),
      toastSub: document.getElementById('toastSub'),
      pill: document.getElementById('pillState'),
      clock: document.getElementById('clock'),
      btnMenu: document.getElementById('btnMenu'),
      btnPrev: document.getElementById('btnPrev'),
      btnNext: document.getElementById('btnNext'),
      btnPlay: document.getElementById('btnPlay'),
      btnCenter: document.getElementById('btnCenter'),
    };

    // í•„ìˆ˜ ì»¨í…Œì´ë„ˆ(view)ê°€ ì—†ìœ¼ë©´ ì—¬ê¸°ì„œ ì›ì¸ í‘œì‹œ
    if (!el.view) {
      showFatal("í•„ìˆ˜ DOM #view ê°€ ì—†ìŒ. index.htmlì— id='view' ìš”ì†Œê°€ ìˆëŠ”ì§€ í™•ì¸í•´.");
      return;
    }

    // ----------------------
    // âœ… Utils
    // ----------------------
    function fmtClock(d = new Date()) {
      const hh = String(d.getHours()).padStart(2, '0');
      const mm = String(d.getMinutes()).padStart(2, '0');
      return `${hh}:${mm}`;
    }
    function tick() {
      if (el.clock) el.clock.textContent = fmtClock();
    }

    function showToast(title, sub = '') {
      // toast UI ì—†ìœ¼ë©´ ì½˜ì†”/ë¬´ì‹œ
      try {
        if (!el.toast || !el.toastTitle || !el.toastSub) return;
        el.toastTitle.textContent = title;
        el.toastSub.textContent = sub;
        el.toast.classList.add('show');
        clearTimeout(showToast._t);
        showToast._t = setTimeout(() => el.toast.classList.remove('show'), 1800);
      } catch (_) {}
    }

    function safeText(s) { return (s ?? '').toString(); }

    function escapeHtml(s) {
      return String(s ?? '').replace(/[&<>"']/g, c => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
      }[c]));
    }
    function escapeAttr(s) { return escapeHtml(s).replace(/"/g, '&quot;'); }

    function getNick() { return localStorage.getItem('runrank_nick') || ''; }
    function setNick(v) { localStorage.setItem('runrank_nick', v); }

    function pickCoverUrl(x) {
      return x?.cover_url || x?.album_art || x?.image_url || '';
    }

    function clampIndex(i, n) {
      if (n <= 0) return 0;
      return (i % n + n) % n;
    }

    function fmtDur(sec) {
      sec = Number(sec || 0);
      const m = Math.floor(sec / 60);
      const s = sec - m * 60;
      return `${m}:${String(s).padStart(2, '0')}`;
    }

    // ----------------------
    // âœ… Online ì²´í¬ (OFFLINE ê¹œë¹¡ì„ ë°©ì§€: 2ì—°ì† ì‹¤íŒ¨ ì‹œ OFFLINE)
    // ----------------------
    let onlineFailStreak = 0;

    async function checkOnline() {
      try {
        const r = await fetch(`/api/health?ts=${Date.now()}`, {
          cache: 'no-store',
          credentials: 'same-origin'
        });
        if (r.ok) {
          onlineFailStreak = 0;
          state.online = true;
        } else {
          onlineFailStreak += 1;
          if (onlineFailStreak >= 2) state.online = false;
        }
      } catch {
        onlineFailStreak += 1;
        if (onlineFailStreak >= 2) state.online = false;
      }
      render();
    }

    function startOnlineMonitor() {
      checkOnline();
      setInterval(checkOnline, 15000);
      window.addEventListener('online', () => setTimeout(checkOnline, 300));
      window.addEventListener('offline', () => setTimeout(checkOnline, 300));
    }

    // ----------------------
    // âœ… Spotify (PKCE)
    // ----------------------
    function getSpotifyClientId() { return localStorage.getItem('runrank_spotify_client_id') || ''; }
    function setSpotifyClientId(v) { localStorage.setItem('runrank_spotify_client_id', v); }
    function getSpotifyToken() { return localStorage.getItem('runrank_spotify_access_token') || ''; }
    function setSpotifyToken(v) { localStorage.setItem('runrank_spotify_access_token', v); }

    async function sha256(str) {
      const enc = new TextEncoder();
      const data = enc.encode(str);
      const hash = await crypto.subtle.digest('SHA-256', data);
      return new Uint8Array(hash);
    }
    function base64url(bytes) {
      let str = '';
      bytes.forEach(b => str += String.fromCharCode(b));
      return btoa(str).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/,'');
    }
    function randString(len = 64) {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
      let out = '';
      const arr = crypto.getRandomValues(new Uint8Array(len));
      for (let i = 0; i < len; i++) out += chars[arr[i] % chars.length];
      return out;
    }

    async function spotifyLogin() {
      const clientId = getSpotifyClientId().trim();
      if (!clientId) return showToast('Spotify', 'Settingsì— Client IDë¶€í„° ë„£ì–´');

      const verifier = randString(64);
      const challenge = base64url(await sha256(verifier));
      const stateStr = randString(16);
      localStorage.setItem('runrank_spotify_verifier', verifier);
      localStorage.setItem('runrank_spotify_oauth_state', stateStr);

      const redirectUri = window.location.origin + '/';
      const scope = [
        'user-read-email',
        'user-read-private',
        'playlist-read-private',
        'playlist-read-collaborative'
      ].join(' ');

      const params = new URLSearchParams({
        client_id: clientId,
        response_type: 'code',
        redirect_uri: redirectUri,
        code_challenge_method: 'S256',
        code_challenge: challenge,
        state: stateStr,
        scope,
      });
      window.location.href = 'https://accounts.spotify.com/authorize?' + params.toString();
    }

    async function handleSpotifyCallback() {
      const url = new URL(window.location.href);
      const code = url.searchParams.get('code');
      const stateStr = url.searchParams.get('state');
      const err = url.searchParams.get('error');

      if (err) {
        showToast('Spotify ì‹¤íŒ¨', err);
        url.searchParams.delete('error');
        window.history.replaceState({}, '', url.toString());
        return;
      }
      if (!code) return;

      const expectedState = localStorage.getItem('runrank_spotify_oauth_state') || '';
      const verifier = localStorage.getItem('runrank_spotify_verifier') || '';
      const clientId = getSpotifyClientId().trim();
      const redirectUri = window.location.origin + '/';

      if (!clientId || !verifier || !expectedState || expectedState !== stateStr) {
        showToast('Spotify', 'state/verifier ë¶ˆì¼ì¹˜');
        return;
      }

      try {
        const body = new URLSearchParams({
          client_id: clientId,
          grant_type: 'authorization_code',
          code,
          redirect_uri: redirectUri,
          code_verifier: verifier,
        });

        const res = await fetch('https://accounts.spotify.com/api/token', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body,
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data?.error_description || data?.error || String(res.status));
        if (data?.access_token) {
          setSpotifyToken(data.access_token);
          showToast('Spotify', 'ì—°ë™ ì™„ë£Œ');
        }
      } catch (e) {
        showToast('Spotify ì‹¤íŒ¨', String(e.message || e).slice(0, 80));
      } finally {
        url.searchParams.delete('code');
        url.searchParams.delete('state');
        window.history.replaceState({}, '', url.toString());
      }
    }

    // ----------------------
    // âœ… API
    // ----------------------
    async function apiGet(path) {
      const res = await fetch(path, { cache: 'no-store', credentials: 'same-origin' });
      if (!res.ok) throw new Error(`${res.status}`);
      return await res.json();
    }

    async function refreshAll() {
      try {
        const [tracks, ranking, hot] = await Promise.all([
          apiGet('/api/tracks'),
          apiGet('/api/ranking'),
          apiGet('/api/hot_ranking'),
        ]);
        state.tracks = Array.isArray(tracks) ? tracks : (tracks?.tracks || []);
        state.ranking = Array.isArray(ranking) ? ranking : (ranking?.ranking || []);
        state.hot = Array.isArray(hot) ? hot : (hot?.ranking || []);
        state.online = true;
        render();
      } catch (e) {
        showToast('ì˜¤í”„ë¼ì¸', 'ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•´ì¤˜');
        state.online = false;
        render();
      }
    }

    async function refreshRuns() {
      try {
        const nick = getNick();
        const qs = nick ? `?user=${encodeURIComponent(nick)}` : '';
        const runs = await apiGet('/api/runs' + qs);
        state.runs = Array.isArray(runs) ? runs : [];
        render();
      } catch (e) {
        showToast('Runs ì‹¤íŒ¨', 'ì„œë²„ ì‘ë‹µì´ ì´ìƒí•´');
      }
    }

    async function submit(trackId) {
      try {
        const body = { track_id: Number(trackId), user: getNick() || null };
        const res = await fetch('/api/submit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
          credentials: 'same-origin',
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || data?.ok === false) throw new Error(data?.error || `${res.status}`);
        showToast('ì¶”ì²œ ì™„ë£Œ', 'ë­í‚¹ì— ë°˜ì˜ëì–´');

        const [ranking, hot] = await Promise.all([
          apiGet('/api/ranking'),
          apiGet('/api/hot_ranking'),
        ]);
        state.ranking = Array.isArray(ranking) ? ranking : (ranking?.ranking || []);
        state.hot = Array.isArray(hot) ? hot : (hot?.ranking || []);
        render();
      } catch (e) {
        showToast('ì‹¤íŒ¨', String(e.message || 'ì„œë²„ ì˜¤ë¥˜').slice(0, 120));
      }
    }

    // ----------------------
    // âœ… Render
    // ----------------------
    function renderHeader(title, hint) {
      return `
        <div class="titleRow">
          <h1>${escapeHtml(title)}</h1>
          <div class="hint">${escapeHtml(hint || '')}</div>
        </div>
      `;
    }

    function normalizeRankingItem(x) {
      const title = safeText(x?.title || x?.track || x?.name || x?.[0] || '');
      const score = x?.votes ?? x?.score ?? x?.count ?? x?.[1] ?? '';
      const artist = safeText(x?.artist || x?.by || x?.[2] || '');
      const cover_url = pickCoverUrl(x);
      return { title, artist, score, cover_url };
    }

    function render() {
      if (el.pill) {
        el.pill.textContent = state.online ? 'ONLINE' : 'OFFLINE';
        el.pill.style.opacity = state.online ? '1' : '0.75';
      }

      if (state.page === 'detail') return renderDetail();
      if (state.page === 'run_new') return renderRunNew();

      if (state.page === 'menu') return renderMenu();
      if (state.page === 'tracks') return renderTracks();
      if (state.page === 'ranking') return renderRanking();
      if (state.page === 'hot') return renderHot();
      if (state.page === 'runs') return renderRuns();
      if (state.page === 'settings') return renderSettings();
      if (state.page === 'about') return renderAbout();

      state.page = 'menu';
      renderMenu();
    }

    function renderMenu() {
      state.menuIndex = clampIndex(state.menuIndex, MENU.length);
      const items = MENU.map((m, idx) => `
        <div class="item ${idx === state.menuIndex ? 'active' : ''}">
          <div class="thumb">âŒ</div>
          <div class="meta">
            <div class="name">${escapeHtml(m.label)}</div>
            <div class="sub">${escapeHtml(m.hint)}</div>
          </div>
          <div class="right">â€º</div>
        </div>
      `).join('');

      el.view.innerHTML = `
        ${renderHeader('RunnerSheep', 'iPod UI')}
        <div class="list">${items}</div>
        <div class="kbd">ì¡°ì‘: <code>â†‘</code><code>â†“</code> ì´ë™ Â· <code>Enter</code> ì„ íƒ Â· <code>Esc</code> ë’¤ë¡œ Â· <code>Space</code> ì²´í¬</div>
      `;
    }

    function renderTracks() {
      const list = state.tracks || [];
      state.listIndex = clampIndex(state.listIndex, list.length);

      const items = list.map((t, idx) => {
        const cover = pickCoverUrl(t);
        const name = safeText(t.title || t.name || t.track || `Track ${t.id ?? ''}`);
        const artist = safeText(t.artist || t.singer || t.by || '');
        const checked = state.checkedTrackIds.has(Number(t.id));
        return `
          <div class="item ${idx === state.listIndex ? 'active' : ''}">
            <div class="thumb">${cover ? `<img alt="" src="${cover}">` : 'â™ª'}</div>
            <div class="meta">
              <div class="name">${escapeHtml(name)}</div>
              <div class="sub">${escapeHtml(artist || ' ')}</div>
            </div>
            <div class="right">${checked ? 'âœ“' : '+'}</div>
          </div>
        `;
      }).join('');

      el.view.innerHTML = `
        ${renderHeader('Tracks', 'â–¶ï¸/â¸=ì²´í¬')}
        <div class="list">${items || '<div class="item"><div class="thumb">!</div><div class="meta"><div class="name">íŠ¸ë™ì´ ì—†ì–´</div><div class="sub">/api/tracks í™•ì¸</div></div></div>'}</div>
        <div class="kbd"><code>Enter</code> ìƒì„¸ Â· <code>Space</code> ì²´í¬/í•´ì œ Â· <code>Esc</code> ë©”ë‰´</div>
      `;
    }

    function renderRanking() {
      const list = (state.ranking || []).map(normalizeRankingItem);
      state.listIndex = clampIndex(state.listIndex, list.length);

      const items = list.map((r, idx) => `
        <div class="item ${idx === state.listIndex ? 'active' : ''}">
          <div class="thumb">${r.cover_url ? `<img alt="" src="${r.cover_url}">` : String(idx + 1)}</div>
          <div class="meta">
            <div class="name">${escapeHtml(r.title || 'â€”')}</div>
            <div class="sub">${escapeHtml(r.artist || ' ')}</div>
          </div>
          <div class="right">${escapeHtml(String(r.score))}</div>
        </div>
      `).join('');

      el.view.innerHTML = `
        ${renderHeader('Ranking', 'ì „ì²´')}
        <div class="list">${items || '<div class="item"><div class="thumb">â€¦</div><div class="meta"><div class="name">ë°ì´í„° ì—†ìŒ</div><div class="sub">ì¶”ì²œì„ ë¨¼ì € í•´ë´</div></div></div>'}</div>
        <div class="kbd"><code>Esc</code> ë©”ë‰´</div>
      `;
    }

    function renderHot() {
      const list = (state.hot || []).map(normalizeRankingItem);
      state.listIndex = clampIndex(state.listIndex, list.length);

      const items = list.map((r, idx) => `
        <div class="item ${idx === state.listIndex ? 'active' : ''}">
          <div class="thumb">${r.cover_url ? `<img alt="" src="${r.cover_url}">` : 'ğŸ”¥'}</div>
          <div class="meta">
            <div class="name">${escapeHtml(r.title || 'â€”')}</div>
            <div class="sub">${escapeHtml(r.artist || ' ')}</div>
          </div>
          <div class="right">${escapeHtml(String(r.score))}</div>
        </div>
      `).join('');

      el.view.innerHTML = `
        ${renderHeader('Hot', 'ìµœê·¼')}
        <div class="list">${items || '<div class="item"><div class="thumb">â€¦</div><div class="meta"><div class="name">ë°ì´í„° ì—†ìŒ</div><div class="sub">ìµœê·¼ ì¶”ì²œì´ ì—†ì–´</div></div></div>'}</div>
        <div class="kbd"><code>Esc</code> ë©”ë‰´</div>
      `;
    }

    function renderRuns() {
      const runs = state.runs || [];
      state.listIndex = clampIndex(state.listIndex, runs.length);

      const items = runs.map((r, idx) => {
        const tracks = Array.isArray(r.tracks) ? r.tracks : [];
        const t0 = tracks[0] || r.track;
        const cover = pickCoverUrl(r.photo_url ? { cover_url: r.photo_url } : t0);
        const baseTitle = t0 ? `${t0.title}` : 'â€”';
        const title = tracks.length > 1 ? `${baseTitle} (+${tracks.length - 1})` : baseTitle;
        const sub = `${r.date_label} Â· ${r.distance_km}km Â· ${fmtDur(r.duration_sec)} Â· ${r.pace}`;
        return `
          <div class="item ${idx === state.listIndex ? 'active' : ''}">
            <div class="thumb">${r.photo_url ? `<img alt="" src="${r.photo_url}">` : (cover ? `<img alt="" src="${cover}">` : 'ğŸƒ')}</div>
            <div class="meta">
              <div class="name">${escapeHtml(title)}</div>
              <div class="sub">${escapeHtml(sub)}</div>
            </div>
            <div class="right">â€º</div>
          </div>
        `;
      }).join('');

      el.view.innerHTML = `
        ${renderHeader('Runs', 'ì„¼í„°=ìƒˆ ê¸°ë¡')}
        <div class="list">${items || '<div class="item"><div class="thumb">ğŸƒ</div><div class="meta"><div class="name">ê¸°ë¡ ì—†ìŒ</div><div class="sub">ì„¼í„°(SELECT)ë¡œ ì²« ê¸°ë¡ ì¶”ê°€</div></div></div>'}</div>
        <div class="kbd"><code>Enter</code> ìƒˆ ê¸°ë¡ Â· <code>Esc</code> ë©”ë‰´</div>
      `;
    }

    function renderRunNew() {
      const nick = getNick();
      const checkedIds = Array.from(state.checkedTrackIds);
      const checkedInfos = checkedIds.map(id => {
        const t = (state.tracks || []).find(x => Number(x.id) === Number(id));
        const title = safeText(t?.title || `Track ${id}`);
        const artist = safeText(t?.artist || '');
        return `${escapeHtml(title)}${artist ? ' - ' + escapeHtml(artist) : ''}`;
      });

      el.view.innerHTML = `
        ${renderHeader('New Run', 'ì‚¬ì§„ ì—…ë¡œë“œ')}
        <div class="detail">
          <div>
            <label>user (ë‹‰ë„¤ì„)</label>
            <input id="run_user" value="${escapeAttr(nick)}" placeholder="ë‹‰ë„¤ì„ ë¨¼ì € ì„¤ì • ì¶”ì²œ" />
          </div>

          <div class="grid2">
            <div>
              <label>distance_km</label>
              <input id="run_dist" type="number" step="0.01" placeholder="ì˜ˆ: 5" />
            </div>
            <div>
              <label>pace (mm:ss / km)</label>
              <input id="run_pace" placeholder="ì˜ˆ: 5:30" />
            </div>
          </div>

          <div class="grid2">
            <div>
              <label>date_label</label>
              <input id="run_date" placeholder="ì˜ˆ: 2026-02-05" />
            </div>
            <div>
              <label>tracks (ì²´í¬í•œ ê³¡)</label>
              <div style="display:flex; gap:8px; align-items:center;">
                <div style="flex:1; font-size:11px; color:var(--muted); line-height:1.35;">
                  ${checkedInfos.length ? `${checkedInfos.length}ê³¡ ì„ íƒë¨` : 'Tracks ë©”ë‰´ì—ì„œ Space ëˆŒëŸ¬ ì²´í¬í•´ì¤˜'}
                </div>
                <button class="btn" id="clear_checked" style="white-space:nowrap;">ì´ˆê¸°í™”</button>
              </div>
              <div style="margin-top:6px; max-height:72px; overflow:auto; font-size:11px;">
                ${checkedInfos.length ? checkedInfos.map(s => `<div style="padding:2px 0; opacity:.92;">â€¢ ${s}</div>`).join('') : ''}
              </div>
            </div>
          </div>

          <div>
            <label>photo</label>
            <label class="btn" for="run_photo" style="display:inline-flex; width:100%; justify-content:center;">
              ì‚¬ì§„ ì„ íƒí•˜ê¸°
            </label>
            <input id="run_photo" type="file" accept="image/*" style="display:none;" />
            <div id="photo_name" style="margin-top:6px;font-size:11px;color:var(--muted);">ì„ íƒëœ íŒŒì¼ ì—†ìŒ</div>
          </div>

          <div class="cta">
            <button class="btn" id="run_cancel">ì·¨ì†Œ</button>
            <button class="btn primary" id="run_submit">ì €ì¥</button>
          </div>
        </div>
        <div class="kbd"><code>Esc</code> ì·¨ì†Œ</div>
      `;

      document.getElementById('run_cancel')?.addEventListener('click', () => {
        state.page = 'runs';
        render();
      });

      const photoInput = document.getElementById('run_photo');
      document.getElementById('clear_checked')?.addEventListener('click', () => {
        state.checkedTrackIds.clear();
        showToast('ì´ˆê¸°í™”', 'ì„ íƒê³¡ 0ê°œ');
        render();
      });

      photoInput?.addEventListener('change', () => {
        const f = photoInput.files?.[0];
        const pn = document.getElementById('photo_name');
        if (pn) pn.textContent = f ? `ì„ íƒë¨: ${f.name}` : 'ì„ íƒëœ íŒŒì¼ ì—†ìŒ';
      });

      document.getElementById('run_submit')?.addEventListener('click', async () => {
        const user = document.getElementById('run_user')?.value.trim() || '';
        const distance_km_raw = document.getElementById('run_dist')?.value.trim() || '';
        const paceStr = document.getElementById('run_pace')?.value.trim() || '';
        const date_label = (document.getElementById('run_date')?.value.trim() || '') || new Date().toISOString().slice(0, 10);
        const track_ids = Array.from(state.checkedTrackIds);
        const photo = document.getElementById('run_photo')?.files?.[0] || null;

        if (!user) return showToast('ì—ëŸ¬', 'user(ë‹‰ë„¤ì„) í•„ìš”');

        const dist = Number(distance_km_raw);
        if (!dist || dist <= 0) return showToast('ì—ëŸ¬', 'distance_km í•„ìš”');

        const m = paceStr.match(/^(\d+)\s*:\s*([0-5]?\d)$/);
        if (!m) return showToast('ì—ëŸ¬', 'pace í˜•ì‹ì€ 5:30 ì²˜ëŸ¼ mm:ss');

        const pace_sec = Number(m[1]) * 60 + Number(m[2]);
        if (pace_sec <= 0) return showToast('ì—ëŸ¬', 'pace í•„ìš”');

        const duration_sec = Math.round(dist * pace_sec);

        const fd = new FormData();
        fd.append('user', user);
        fd.append('distance_km', String(dist));
        fd.append('duration_sec', String(duration_sec));
        fd.append('date_label', date_label);
        if (track_ids.length) fd.append('track_ids', JSON.stringify(track_ids));
        if (photo) fd.append('photo', photo);

        try {
          const res = await fetch('/api/runs', { method: 'POST', body: fd, credentials: 'same-origin' });
          const data = await res.json().catch(() => ({}));
          if (!res.ok || data?.ok === false) throw new Error(data?.error || `${res.status}`);

          const vote = data?.vote;
          if (vote?.did_vote) {
            showToast('ì €ì¥+íˆ¬í‘œ', `pace: ${data.pace} Â· ${vote.inserted}ê³¡ íˆ¬í‘œë¨`);
          } else if (vote?.already_voted) {
            showToast('ì €ì¥ë¨', `pace: ${data.pace} Â· ì˜¤ëŠ˜ì€ ì´ë¯¸ íˆ¬í‘œí–ˆì–´`);
          } else {
            showToast('ì €ì¥ë¨', `pace: ${data.pace}`);
          }

          if (vote?.did_vote) state.checkedTrackIds.clear();
          state.page = 'runs';
          await refreshRuns();
        } catch (e) {
          showToast('ì‹¤íŒ¨', String(e.message || 'ì„œë²„ ì˜¤ë¥˜').slice(0, 120));
        }
      });
    }

    function renderSettings() {
      const nick = getNick();
      const spClientId = getSpotifyClientId();
      const spConnected = !!getSpotifyToken();

      el.view.innerHTML = `
        ${renderHeader('Settings', 'ë‹‰ë„¤ì„')}
        <div class="detail">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
            <div style="font-weight:900; font-size:13px;">Nickname</div>
            <div style="font-size:11px; color: var(--muted);">ì¶”ì²œ/ëŸ° ê¸°ë¡ì— ì‚¬ìš©</div>
          </div>

          <div style="display:flex; gap:8px; align-items:center;">
            <input id="nickInput" value="${escapeAttr(nick)}" placeholder="ì˜ˆ) joon" style="flex:1;">
            <button class="btn primary" id="saveNick">ì €ì¥</button>
          </div>

          <div style="margin-top:8px; font-size:11px; color: var(--muted); line-height:1.35;">
            ì»¤ë²„ ìë™ ì±„ìš°ê¸°: ì•„ë˜ ë²„íŠ¼ ëˆ„ë¥´ë©´ ì»¤ë²„ ì—†ëŠ” íŠ¸ë™ ì¼ë¶€ë¥¼ ì„œë²„ê°€ iTunesë¡œ ì°¾ì•„ ìºì‹œì— ì €ì¥í•¨.
          </div>

          <div class="cta">
            <button class="btn" id="fillCovers">ì»¤ë²„ ì±„ìš°ê¸°</button>
            <button class="btn" id="refreshBtn">ìƒˆë¡œê³ ì¹¨</button>
          </div>

          <div class="cta">
            <button class="btn" id="clearNick">ë‹‰ë„¤ì„ ì§€ìš°ê¸°</button>
            <button class="btn" id="loadRuns">ë‚´ Runs ë¶ˆëŸ¬ì˜¤ê¸°</button>
          </div>

          <div style="margin-top:10px; padding-top:10px; border-top:1px solid rgba(255,255,255,.10);"></div>

          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
            <div style="font-weight:900; font-size:13px;">Spotify</div>
            <div style="font-size:11px; color: var(--muted);">PKCE ì—°ë™</div>
          </div>

          <div style="margin-top:6px; font-size:11px; color: var(--muted); line-height:1.35;">
            Redirect URIëŠ” <b style="color:var(--text)">${escapeHtml(window.location.origin + '/')}</b> ë¡œ ë“±ë¡í•´ì•¼ í•¨.
          </div>

          <div style="display:flex; gap:8px; align-items:center; margin-top:8px;">
            <input id="spClientId" value="${escapeAttr(spClientId)}" placeholder="Spotify Client ID" style="flex:1;" />
            <button class="btn primary" id="spSave">ì €ì¥</button>
          </div>

          <div class="cta">
            <button class="btn ${spConnected ? 'primary' : ''}" id="spConnect">${spConnected ? 'ì—°ë™ë¨(ë‹¤ì‹œ)' : 'Spotify ì—°ë™'}</button>
            <button class="btn" id="spDisconnect">ì—°ë™ í•´ì œ</button>
          </div>
        </div>
        <div class="kbd"><code>Esc</code> ë©”ë‰´</div>
      `;

      document.getElementById('saveNick')?.addEventListener('click', () => {
        const v = document.getElementById('nickInput')?.value.trim() || '';
        setNick(v);
        showToast('ì €ì¥ë¨', v ? `ë‹‰ë„¤ì„: ${v}` : 'ë¹„ì›Œë’€ì–´');
        render();
      });

      document.getElementById('clearNick')?.addEventListener('click', () => {
        setNick('');
        showToast('ì‚­ì œë¨', 'ë‹‰ë„¤ì„ ì œê±°');
        render();
      });

      document.getElementById('refreshBtn')?.addEventListener('click', async () => {
        showToast('ê°±ì‹ ', 'ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦');
        await refreshAll();
      });

      document.getElementById('fillCovers')?.addEventListener('click', async () => {
        try {
          showToast('ì»¤ë²„', 'ì°¾ëŠ” ì¤‘â€¦');
          const t = await apiGet('/api/tracks?resolve_missing=1&resolve_limit=10');
          state.tracks = Array.isArray(t) ? t : [];
          showToast('ì™„ë£Œ', 'Tracksì— ë°˜ì˜ë¨');
          render();
        } catch (e) {
          showToast('ì‹¤íŒ¨', 'ì»¤ë²„ ì±„ìš°ê¸° ì˜¤ë¥˜');
        }
      });

      document.getElementById('loadRuns')?.addEventListener('click', async () => {
        state.page = 'runs';
        await refreshRuns();
      });

      document.getElementById('spSave')?.addEventListener('click', () => {
        setSpotifyClientId(document.getElementById('spClientId')?.value.trim() || '');
        showToast('Spotify', 'Client ID ì €ì¥ë¨');
      });
      document.getElementById('spConnect')?.addEventListener('click', () => spotifyLogin());
      document.getElementById('spDisconnect')?.addEventListener('click', () => {
        setSpotifyToken('');
        localStorage.removeItem('runrank_spotify_verifier');
        localStorage.removeItem('runrank_spotify_oauth_state');
        showToast('Spotify', 'ì—°ë™ í•´ì œ');
        render();
      });
    }

    function renderAbout() {
      el.view.innerHTML = `
        ${renderHeader('About', 'RunRank')}
        <div class="detail">
          <div style="font-weight:900;">ì´ë²ˆ ì—…ë°ì´íŠ¸</div>
          <div style="font-size:11px; color: var(--muted); line-height:1.45;">
            âœ… ì•¨ë²”ì»¤ë²„: ì„œë²„ ìºì‹œ + iTunes ê²€ìƒ‰<br/>
            âœ… Runs: ëŸ°ë‹ ê¸°ë¡ + ì‚¬ì§„ ì—…ë¡œë“œ<br/>
            <br/>
            API:
            <span style="color: var(--accent);">/api/tracks</span>,
            <span style="color: var(--accent);">/api/covers/resolve_all</span>,
            <span style="color: var(--accent);">/api/runs</span>
          </div>
          <div style="margin-top:auto; display:flex; gap:8px; flex-wrap:wrap;">
            <span class="btn">v0.4</span>
            <span class="btn">Covers</span>
            <span class="btn">Runs+Photo</span>
          </div>
        </div>
        <div class="kbd"><code>Esc</code> ë©”ë‰´</div>
      `;
    }

    function renderDetail() {
      const t = state.selectedTrack;
      if (!t) { state.page = 'tracks'; return renderTracks(); }

      const cover = pickCoverUrl(t);
      const name = safeText(t.title || t.name || t.track || `Track ${t.id ?? ''}`);
      const artist = safeText(t.artist || t.singer || t.by || '');
      const id = t.id ?? t.track_id ?? t.trackId;

      el.view.innerHTML = `
        ${renderHeader('Track', 'ìƒì„¸')}
        <div class="detail">
          <div style="display:flex; gap:10px; align-items:center;">
            <div class="thumb" style="width:56px;height:56px;border-radius:12px;">
              ${cover ? `<img alt="" src="${cover}">` : 'â™ª'}
            </div>
            <div style="min-width:0;">
              <div style="font-weight:900; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${escapeHtml(name)}</div>
              <div style="font-size:11px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${escapeHtml(artist || ' ')}</div>
            </div>
          </div>

          <div style="font-size:11px; color: var(--muted); line-height:1.45;">
            <div>Track ID: <b style="color:var(--text)">${escapeHtml(String(id))}</b></div>
            <div>Space : ì²´í¬/í•´ì œ</div>
          </div>

          <div class="cta">
            <button class="btn" id="backBtn">ë’¤ë¡œ</button>
            <button class="btn primary" id="voteBtn">ì¶”ì²œ(Like)</button>
          </div>
        </div>
        <div class="kbd"><code>Space</code> ì²´í¬ Â· <code>Esc</code> ë’¤ë¡œ</div>
      `;

      document.getElementById('backBtn')?.addEventListener('click', () => goBack());
      document.getElementById('voteBtn')?.addEventListener('click', () => submit(id));
    }

    function goTo(page) {
      state.page = page;
      state.listIndex = 0;
      render();
    }

    function goBack() {
      if (state.page === 'detail') { state.page = 'tracks'; return render(); }
      if (state.page === 'run_new') { state.page = 'runs'; return render(); }
      state.page = 'menu';
      render();
    }

    function moveUp() {
      if (state.page === 'menu') state.menuIndex--;
      else state.listIndex--;
      render();
    }
    function moveDown() {
      if (state.page === 'menu') state.menuIndex++;
      else state.listIndex++;
      render();
    }

    function select() {
      if (state.page === 'menu') {
        const key = MENU[clampIndex(state.menuIndex, MENU.length)]?.key;
        if (key === 'runs') { state.page = 'runs'; refreshRuns(); return; }
        return goTo(key || 'tracks');
      }
      if (state.page === 'tracks') {
        const list = state.tracks || [];
        const t = list[clampIndex(state.listIndex, list.length)];
        if (!t) return;
        state.selectedTrack = t;
        state.page = 'detail';
        return render();
      }
      if (state.page === 'runs') {
        state.page = 'run_new';
        return render();
      }
    }

    function toggleCheck() {
      let id = null;

      if (state.page === 'tracks') {
        const list = state.tracks || [];
        const t = list[clampIndex(state.listIndex, list.length)];
        id = t?.id ?? t?.track_id ?? t?.trackId;
      } else if (state.page === 'detail') {
        id = state.selectedTrack?.id ?? state.selectedTrack?.track_id ?? state.selectedTrack?.trackId;
      }

      if (id == null) return;
      id = Number(id);

      if (state.checkedTrackIds.has(id)) {
        state.checkedTrackIds.delete(id);
        showToast('í•´ì œ', `ì„ íƒê³¡ ${state.checkedTrackIds.size}ê°œ`);
      } else {
        state.checkedTrackIds.add(id);
        showToast('ì²´í¬', `ì„ íƒê³¡ ${state.checkedTrackIds.size}ê°œ`);
      }
      render();
    }

    function attachClickWheelRotation() {
      const wheel = document.querySelector('.wheel');
      const center = document.getElementById('btnCenter');
      if (!wheel || !center) return;
      if (wheel.dataset.bound === '1') return;
      wheel.dataset.bound = '1';

      let dragging = false;
      let lastAngle = 0;
      let accum = 0;
      const STEP_DEG = 22;

      function angleFromEvent(ev) {
        const r = wheel.getBoundingClientRect();
        const cx = r.left + r.width / 2;
        const cy = r.top + r.height / 2;
        const x = ev.clientX - cx;
        const y = ev.clientY - cy;
        let a = Math.atan2(y, x) * 180 / Math.PI;
        if (a < 0) a += 360;
        return a;
      }

      function isOnOuterRing(ev) {
        const r = wheel.getBoundingClientRect();
        const cx = r.left + r.width / 2;
        const cy = r.top + r.height / 2;
        const dx = ev.clientX - cx;
        const dy = ev.clientY - cy;
        const dist = Math.sqrt(dx * dx + dy * dy);
        const outer = r.width / 2;
        const inner = outer * 0.33;
        return dist <= outer && dist >= inner;
      }

      function rotateStep(dir) {
        if (state.page === 'menu') {
          state.menuIndex = clampIndex(state.menuIndex + dir, MENU.length);
          render();
          return;
        }

        const listLen =
          state.page === 'tracks' ? (state.tracks || []).length :
          state.page === 'ranking' ? (state.ranking || []).length :
          state.page === 'hot' ? (state.hot || []).length :
          state.page === 'runs' ? (state.runs || []).length :
          0;

        if (listLen > 0) {
          state.listIndex = clampIndex(state.listIndex + dir, listLen);
          render();
        }
      }

      wheel.addEventListener('pointerdown', (ev) => {
        if (ev.target === center || center.contains(ev.target)) return;
        if (!isOnOuterRing(ev)) return;
        dragging = true;
        lastAngle = angleFromEvent(ev);
        accum = 0;
        wheel.setPointerCapture(ev.pointerId);
      });

      wheel.addEventListener('pointermove', (ev) => {
        if (!dragging) return;
        if (!isOnOuterRing(ev)) return;

        const a = angleFromEvent(ev);
        let delta = a - lastAngle;
        if (delta > 180) delta -= 360;
        if (delta < -180) delta += 360;

        lastAngle = a;
        accum += delta;

        while (accum >= STEP_DEG) { rotateStep(+1); accum -= STEP_DEG; }
        while (accum <= -STEP_DEG) { rotateStep(-1); accum += STEP_DEG; }
      });

      wheel.addEventListener('pointerup', () => { dragging = false; });
      wheel.addEventListener('pointercancel', () => { dragging = false; });
    }

    function bind() {
      // ë²„íŠ¼ì´ ì—†ìœ¼ë©´ ê·¸ëƒ¥ ìŠ¤í‚µ (ëª¨ë°”ì¼/ë ˆì´ì•„ì›ƒ ì°¨ì´ ëŒ€ë¹„)
      el.btnMenu?.addEventListener('click', goBack);
      el.btnPrev?.addEventListener('click', moveUp);
      el.btnNext?.addEventListener('click', moveDown);
      el.btnCenter?.addEventListener('click', select);
      el.btnPlay?.addEventListener('click', toggleCheck);

      attachClickWheelRotation();

      window.addEventListener('keydown', (e) => {
        const k = e.key;
        if (k === 'ArrowUp') { e.preventDefault(); moveUp(); }
        else if (k === 'ArrowDown') { e.preventDefault(); moveDown(); }
        else if (k === 'Enter') { e.preventDefault(); select(); }
        else if (k === 'Escape') { e.preventDefault(); goBack(); }
        else if (k === ' ') { e.preventDefault(); toggleCheck(); }
      });
    }

    // ----------------------
    // âœ… ë¶€íŒ… ìˆœì„œ
    // ----------------------
    bind();
    tick();
    setInterval(tick, 1000 * 10);

    // ë©”ë‰´ëŠ” ë°ì´í„° ì—†ì–´ë„ ëœ¨ê²Œ
    render();

    // OAuth ì²˜ë¦¬
    handleSpotifyCallback();

    // ì˜¨ë¼ì¸ + ë°ì´í„° ë¡œë“œ
    startOnlineMonitor();
    refreshAll();

  } catch (e) {
    showFatal(e);
  }
})();
</script>

