<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>RunRank</title>

  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#0f0f12">

  <style>
    :root{
      --bg:#0b0b0f;
      --device:#e9e9ee;
      --device2:#d7d7de;
      --shadow: rgba(0,0,0,.35);
      --screen:#0f1620;
      --screen2:#121b27;
      --text:#eaf0ff;
      --muted:#9db0d1;
      --accent:#7bdcff;
      --line: rgba(255,255,255,.12);
      --danger:#ff6b6b;
      --ok:#6bffb0;
      --radius: 26px;
      --screenRadius: 12px;
      --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", "Apple SD Gothic Neo", Helvetica, Arial, sans-serif;
    }
    html,body{height:100%; margin:0; background: radial-gradient(1200px 800px at 70% 20%, #1a2b3a 0%, var(--bg) 55%, #06060a 100%); color:var(--text); font-family:var(--font);}
    *{box-sizing:border-box;}
    a{color:inherit}

    .wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:26px 18px;}
    .ipod{width:min(360px, 92vw);aspect-ratio:9/14;border-radius:36px;background:linear-gradient(180deg,var(--device) 0%,var(--device2) 100%);box-shadow:0 24px 70px var(--shadow);padding:18px 16px 20px;position:relative;}
    .ipod:before{content:"";position:absolute;inset:10px 10px auto 10px;height:20px;border-radius:16px;background:rgba(255,255,255,.35);filter:blur(.2px);}

    .screen{height:40%;border-radius:var(--screenRadius);background:linear-gradient(180deg,var(--screen2),var(--screen));border:1px solid rgba(0,0,0,.25);box-shadow:inset 0 0 0 1px rgba(255,255,255,.06);padding:10px 10px 12px;overflow:hidden;position:relative;}
    .status{display:flex;align-items:center;justify-content:space-between;font-size:12px;color:var(--muted);letter-spacing:.2px;padding:2px 2px 6px;}
    .status .pill{font-size:11px;padding:2px 8px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.09);color:var(--muted);}

    .view{height:calc(100% - 26px);display:flex;flex-direction:column;gap:8px;}
    .titleRow{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:0 2px;}
    .titleRow h1{margin:0;font-size:14px;font-weight:800;letter-spacing:.4px;}
    .titleRow .hint{font-size:11px;color:var(--muted);}

    .list{flex:1;overflow:auto;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);padding:6px;-webkit-overflow-scrolling:touch;}
    .item{display:flex;align-items:center;gap:10px;padding:8px 8px;border-radius:10px;cursor:default;user-select:none;}
    .item + .item{margin-top:6px;}
    .item .thumb{width:28px;height:28px;border-radius:6px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.10);overflow:hidden;flex:0 0 auto;display:grid;place-items:center;color:rgba(255,255,255,.55);font-size:12px;}
    .item .thumb img{width:100%;height:100%;object-fit:cover;display:block;}
    .item .meta{min-width:0;}
    .item .meta .name{font-size:12px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;line-height:1.2;}
    .item .meta .sub{margin-top:2px;font-size:11px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;line-height:1.2;}
    .item .right{margin-left:auto;font-size:12px;color:var(--muted);font-variant-numeric:tabular-nums;}
    .item.active{background:rgba(123,220,255,.16);border:1px solid rgba(123,220,255,.30);}
    .item.active .right{color:var(--text);}

    .detail{
      display:flex;
      flex-direction:column;
      gap:10px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.04);
      padding:10px;
      height:100%;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      padding-bottom: 22px;
    }

    input{
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.12);
      color: var(--text);
      border-radius: 10px;
      padding: 10px 10px;
      outline: none;
      font-size: 12px;
    }

    .cta{display:flex;gap:8px;flex-wrap:wrap;}
    .btn{
      border:1px solid rgba(0,0,0,.18);
      background: rgba(255,255,255,.18);
      color: rgba(10,10,14,.88);
      border-radius: 999px;
      padding: 9px 12px;
      font-weight: 900;
      font-size: 12px;
      cursor:pointer;
      user-select:none;
    }
    .btn.primary{background: rgba(123,220,255,.40);}
    .btn:active{transform: translateY(1px);}

    .wheelWrap{height:60%;display:flex;align-items:center;justify-content:center;padding-top:14px;}
    .wheel{width:82%;aspect-ratio:1/1;border-radius:999px;background:radial-gradient(circle at 35% 30%,rgba(255,255,255,.65),rgba(255,255,255,.22) 35%,rgba(0,0,0,.05) 66%,rgba(0,0,0,.10) 100%);border:1px solid rgba(0,0,0,.20);box-shadow:inset 0 0 0 1px rgba(255,255,255,.35),0 10px 28px rgba(0,0,0,.16);position:relative;user-select:none;touch-action:none;}
    .wheel .center{position:absolute;inset:30%;border-radius:999px;background:radial-gradient(circle at 30% 30%,rgba(255,255,255,.85),rgba(255,255,255,.20) 60%,rgba(0,0,0,.06) 100%);border:1px solid rgba(0,0,0,.20);box-shadow:inset 0 0 0 1px rgba(255,255,255,.35);display:grid;place-items:center;font-weight:900;color:rgba(20,20,24,.65);cursor:pointer;}
    .wheelBtn{position:absolute;display:grid;place-items:center;width:36%;height:20%;font-size:12px;font-weight:900;color:rgba(20,20,24,.65);cursor:pointer;}
    .wheelBtn.top{top:4%;left:32%;}
    .wheelBtn.bottom{bottom:4%;left:32%;}
    .wheelBtn.left{left:4%;top:40%;}
    .wheelBtn.right{right:4%;top:40%;}
    .wheelBtn small{opacity:.9}

    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background: rgba(0,0,0,.72);
      border:1px solid rgba(255,255,255,.12);
      color: var(--text);
      border-radius: 14px;
      padding: 10px 12px;
      width: min(340px, 92vw);
      box-shadow: 0 14px 36px rgba(0,0,0,.35);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
    }
    .toast.on{opacity:1; transform:translateX(-50%) translateY(-2px);}
    .toast .t{font-weight:900;font-size:12px;}
    .toast .s{margin-top:2px;font-size:11px;color:rgba(255,255,255,.72);}

    .kbd{font-size:11px;color:var(--muted);line-height:1.4;padding:0 2px;}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="ipod">
      <div class="screen">
        <div class="status">
          <div id="clock">--:--</div>
          <div class="pill" id="pillState">ONLINE</div>
        </div>

        <div class="view" id="view"></div>
      </div>

      <div class="wheelWrap">
        <div class="wheel">
          <div class="wheelBtn top" id="btnMenu"><small>MENU</small></div>
          <div class="wheelBtn left" id="btnPrev" aria-label="Previous">
            <svg viewBox="0 0 24 24" width="22" height="22"><path d="M6 5h2v14H6zM20 6v12l-10-6z"/></svg>
          </div>
          <div class="wheelBtn right" id="btnNext" aria-label="Next">
            <svg viewBox="0 0 24 24" width="22" height="22"><path d="M16 5h2v14h-2zM4 6v12l10-6z"/></svg>
          </div>
          <div class="wheelBtn bottom" id="btnPlay" aria-label="Play/Pause">
            <svg id="iconPlay" viewBox="0 0 24 24" width="22" height="22"><path d="M8 5v14l11-7z"/></svg>
          </div>
          <div class="center" id="btnCenter">OK</div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">
    <div class="t" id="toastTitle">â€”</div>
    <div class="s" id="toastSub">â€”</div>
  </div>

<script>
(() => {
  // Service Worker
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', async () => {
      try {
        const reg = await navigator.serviceWorker.register('/service-worker.js');
        try { await reg.update(); } catch (e) {}
      } catch (e) {}
    });
  }

  const state = {
    page: 'menu',
    menuIndex: 0,
    listIndex: 0,
    tracks: [],
    ranking: [],
    hot: [],
    runs: [],
    selectedTrack: null,
    selectedRun: null,
    checkedTrackIds: new Set(),
    online: true,
    voteArmed: false,
  };

  const MENU = [
    { key: 'tracks',   label: 'Tracks',   hint: 'ê³¡ ëª©ë¡ / ì¶”ì²œ' },
    { key: 'ranking',  label: 'Ranking',  hint: 'ì „ì²´ ë­í‚¹' },
    { key: 'hot',      label: 'Hot',      hint: 'ìµœê·¼ ì¸ê¸°' },
    { key: 'runs',     label: 'Runs',     hint: 'ëŸ°ë‹ ê¸°ë¡ + ì‚¬ì§„' },
    { key: 'settings', label: 'Settings', hint: 'ë‹‰ë„¤ì„ / ì˜µì…˜' },
    { key: 'about',    label: 'About',    hint: 'ì•± ì •ë³´' },
  ];

  const el = {
    view: document.getElementById('view'),
    toast: document.getElementById('toast'),
    toastTitle: document.getElementById('toastTitle'),
    toastSub: document.getElementById('toastSub'),
    pill: document.getElementById('pillState'),
    clock: document.getElementById('clock'),
    btnMenu: document.getElementById('btnMenu'),
    btnPrev: document.getElementById('btnPrev'),
    btnNext: document.getElementById('btnNext'),
    btnPlay: document.getElementById('btnPlay'),
    btnCenter: document.getElementById('btnCenter'),
  };

  function fmtClock(d = new Date()) {
    const hh = String(d.getHours()).padStart(2, '0');
    const mm = String(d.getMinutes()).padStart(2, '0');
    return `${hh}:${mm}`;
  }

  let toastTimer = null;
  function showToast(title, sub = '') {
    clearTimeout(toastTimer);
    el.toastTitle.textContent = title;
    el.toastSub.textContent = sub;
    el.toast.classList.add('on');
    toastTimer = setTimeout(() => el.toast.classList.remove('on'), 1600);
  }

  function safeText(s) { return (s ?? '').toString(); }
  function escapeHtml(s) {
    return safeText(s).replace(/[&<>"']/g, (ch) => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[ch]));
  }
  function escapeAttr(s) { return escapeHtml(s).replace(/"/g, '&quot;'); }

  function getNick() { return localStorage.getItem('runrank_nick') || ''; }
  function setNick(v) { localStorage.setItem('runrank_nick', v); }

  async function checkOnline() {
    try {
      const res = await fetch('/api/health', { cache: 'no-store' });
      state.online = !!res.ok;
    } catch {
      state.online = false;
    }
    el.pill.textContent = state.online ? 'ONLINE' : 'OFFLINE';
    el.pill.style.opacity = state.online ? '1' : '0.75';
  }
  function startOnlineMonitor() { checkOnline(); setInterval(checkOnline, 15000); }

  function pickCoverUrl(x) { return x?.cover_url || x?.album_art || x?.image_url || ''; }

  async function apiGet(path) {
    const res = await fetch(path, { cache: 'no-store' });
    if (!res.ok) throw new Error(`${res.status}`);
    return await res.json();
  }

  async function refreshAll() {
    try {
      const [tracks, ranking, hot] = await Promise.all([
        apiGet('/api/tracks?resolve_missing=1&resolve_limit=20'),
        apiGet('/api/ranking'),
        apiGet('/api/hot_ranking'),
      ]);
      state.tracks = Array.isArray(tracks) ? tracks : (tracks?.tracks || []);
      state.ranking = Array.isArray(ranking) ? ranking : (ranking?.ranking || []);
      state.hot = Array.isArray(hot) ? hot : (hot?.ranking || []);
      state.online = true;
      render();
    } catch (e) {
      showToast('ì˜¤í”„ë¼ì¸', 'ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•´ì¤˜');
      state.online = false;
      render();
    }
  }

  async function refreshRuns() {
    try {
      const nick = getNick();
      const qs = nick ? `?user=${encodeURIComponent(nick)}` : '';
      const runs = await apiGet('/api/runs' + qs);
      state.runs = Array.isArray(runs) ? runs : [];
      render();
    } catch (e) {
      showToast('Runs ì‹¤íŒ¨', 'ì„œë²„ ì‘ë‹µì´ ì´ìƒí•´');
    }
  }

  async function submit(trackId) {
    try {
      const body = { track_id: Number(trackId), user: getNick() || null };
      const res = await fetch('/api/submit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok || data?.ok === false) throw new Error(data?.error || `${res.status}`);
      showToast('íˆ¬í‘œ ì™„ë£Œ', 'ë­í‚¹ì— ë°˜ì˜ëì–´');

      const [ranking, hot] = await Promise.all([
        apiGet('/api/ranking'),
        apiGet('/api/hot_ranking'),
      ]);
      state.ranking = Array.isArray(ranking) ? ranking : (ranking?.ranking || []);
      state.hot = Array.isArray(hot) ? hot : (hot?.ranking || []);
      render();
    } catch (e) {
      showToast('ì‹¤íŒ¨', String(e.message || 'ì„œë²„ ì˜¤ë¥˜').slice(0, 80));
    }
  }

  function clampIndex(i, n) { if (n <= 0) return 0; return (i % n + n) % n; }

  function renderHeader(title, hint) {
    return `<div class="titleRow"><h1>${title}</h1><div class="hint">${hint || ''}</div></div>`;
  }

  function ensureActiveInView() {
    const list = el.view.querySelector('.list');
    const active = el.view.querySelector('.item.active');
    if (!list || !active) return;
    try {
      active.scrollIntoView({ block: 'nearest' });
    } catch (e) {
      const top = active.offsetTop;
      const bottom = top + active.offsetHeight;
      if (top < list.scrollTop) list.scrollTop = top;
      else if (bottom > list.scrollTop + list.clientHeight) list.scrollTop = bottom - list.clientHeight;
    }
  }

  function normalizeRankingItem(x) {
    const title = safeText(x?.title || x?.track || x?.name || x?.[0] || '');
    const score = x?.votes ?? x?.score ?? x?.count ?? x?.[1] ?? '';
    const artist = safeText(x?.artist || x?.by || x?.[2] || '');
    const cover_url = pickCoverUrl(x);
    return { title, artist, score, cover_url };
  }

  function fmtDur(sec) {
    sec = Number(sec || 0);
    const m = Math.floor(sec / 60);
    const s = sec - m * 60;
    return `${m}:${String(s).padStart(2, '0')}`;
  }

  function render() {
    el.pill.textContent = state.online ? 'ONLINE' : 'OFFLINE';
    el.pill.style.opacity = state.online ? '1' : '0.75';

    if (state.page === 'detail') return renderDetail();
    if (state.page === 'run_create') return renderRunCreate();
    if (state.page === 'run_detail') return renderRunDetail();
    if (state.page === 'menu') return renderMenu();
    if (state.page === 'tracks') return renderTracks();
    if (state.page === 'ranking') return renderRanking();
    if (state.page === 'hot') return renderHot();
    if (state.page === 'runs') return renderRuns();
    if (state.page === 'settings') return renderSettings();
    if (state.page === 'about') return renderAbout();

    state.page = 'menu';
    renderMenu();
  }

  function renderMenu() {
    state.menuIndex = clampIndex(state.menuIndex, MENU.length);
    const items = MENU.map((m, idx) => `
      <div class="item ${idx === state.menuIndex ? 'active' : ''}">
        <div class="thumb">âŒ</div>
        <div class="meta"><div class="name">${m.label}</div><div class="sub">${m.hint}</div></div>
        <div class="right">â€º</div>
      </div>
    `).join('');

    el.view.innerHTML = `
      ${renderHeader('RunRank', 'iPod UI')}
      <div class="list">${items}</div>
      <div class="kbd">ì¡°ì‘: <code>â†‘</code><code>â†“</code> ì´ë™ Â· <code>OK</code> ì„ íƒ Â· <code>MENU</code> í™ˆ Â· <code>PLAY</code> ì²´í¬</div>
    `;
    requestAnimationFrame(ensureActiveInView);
  }

  function renderTracks() {
    const list = state.tracks || [];
    state.listIndex = clampIndex(state.listIndex, list.length);

    const items = list.map((t, idx) => {
      const cover = pickCoverUrl(t);
      const name = safeText(t.title || t.name || t.track || `Track ${t.id ?? ''}`);
      const artist = safeText(t.artist || t.singer || t.by || '');
      const checked = state.checkedTrackIds.has(Number(t.id));
      return `
        <div class="item ${idx === state.listIndex ? 'active' : ''}">
          <div class="thumb">${cover ? `<img alt="" src="${cover}" onerror="this.remove()">` : 'â™ª'}</div>
          <div class="meta"><div class="name">${escapeHtml(name)}</div><div class="sub">${escapeHtml(artist || ' ')}</div></div>
          <div class="right">${checked ? 'âœ“' : '+'}</div>
        </div>
      `;
    }).join('');

    el.view.innerHTML = `
      ${renderHeader('Tracks', 'OK=ìƒì„¸')}
      <div class="list">${items || '<div class="item"><div class="thumb">!</div><div class="meta"><div class="name">íŠ¸ë™ì´ ì—†ì–´</div><div class="sub">/api/tracks í™•ì¸</div></div></div>'}</div>
      <div class="kbd"><code>OK</code> ìƒì„¸ Â· <code>PLAY</code> ì²´í¬/í•´ì œ Â· <code>MENU</code> í™ˆ</div>
    `;
    requestAnimationFrame(ensureActiveInView);
  }

  function renderRanking() {
    const list = (state.ranking || []).map(normalizeRankingItem);
    state.listIndex = clampIndex(state.listIndex, list.length);

    const items = list.map((r, idx) => `
      <div class="item ${idx === state.listIndex ? 'active' : ''}">
        <div class="thumb">${r.cover_url ? `<img alt="" src="${r.cover_url}" onerror="this.remove()">` : String(idx + 1)}</div>
        <div class="meta"><div class="name">${escapeHtml(r.title || 'â€”')}</div><div class="sub">${escapeHtml(r.artist || ' ')}</div></div>
        <div class="right">${escapeHtml(String(r.score))}</div>
      </div>
    `).join('');

    el.view.innerHTML = `
      ${renderHeader('Ranking', 'ì „ì²´')}
      <div class="list">${items || '<div class="item"><div class="thumb">â€¦</div><div class="meta"><div class="name">ë°ì´í„° ì—†ìŒ</div><div class="sub">íˆ¬í‘œë¥¼ ë¨¼ì € í•´ë´</div></div></div>'}</div>
      <div class="kbd"><code>MENU</code> í™ˆ</div>
    `;
    requestAnimationFrame(ensureActiveInView);
  }

  function renderHot() {
    const list = (state.hot || []).map(normalizeRankingItem);
    state.listIndex = clampIndex(state.listIndex, list.length);

    const items = list.map((r, idx) => `
      <div class="item ${idx === state.listIndex ? 'active' : ''}">
        <div class="thumb">${r.cover_url ? `<img alt="" src="${r.cover_url}" onerror="this.remove()">` : 'ğŸ”¥'}</div>
        <div class="meta"><div class="name">${escapeHtml(r.title || 'â€”')}</div><div class="sub">${escapeHtml(r.artist || ' ')}</div></div>
        <div class="right">${escapeHtml(String(r.score))}</div>
      </div>
    `).join('');

    el.view.innerHTML = `
      ${renderHeader('Hot', 'ìµœê·¼')}
      <div class="list">${items || '<div class="item"><div class="thumb">â€¦</div><div class="meta"><div class="name">ë°ì´í„° ì—†ìŒ</div><div class="sub">ìµœê·¼ íˆ¬í‘œê°€ ì—†ì–´</div></div></div>'}</div>
      <div class="kbd"><code>MENU</code> í™ˆ</div>
    `;
    requestAnimationFrame(ensureActiveInView);
  }

  function renderRuns() {
    const runs = state.runs || [];
    state.listIndex = clampIndex(state.listIndex, runs.length);

    const items = runs.map((r, idx) => {
      const cover = r.photo_url ? r.photo_url : '';
      const sub = `${r.date_label} Â· ${r.distance_km}km Â· ${fmtDur(r.duration_sec)} Â· ${r.pace}`;
      return `
        <div class="item ${idx === state.listIndex ? 'active' : ''}">
          <div class="thumb">${cover ? `<img alt="" src="${cover}" onerror="this.remove()">` : 'ğŸƒ'}</div>
          <div class="meta"><div class="name">${escapeHtml(r.date_label || 'Run')}</div><div class="sub">${escapeHtml(sub)}</div></div>
          <div class="right">â€º</div>
        </div>
      `;
    }).join('');

    el.view.innerHTML = `
      ${renderHeader('Runs', 'OK=ì‘ì„±')}
      <div class="list">${items || '<div class="item"><div class="thumb">ğŸƒ</div><div class="meta"><div class="name">ê¸°ë¡ ì—†ìŒ</div><div class="sub">OK ëˆŒëŸ¬ì„œ ê¸°ë¡ ë§Œë“¤ê¸°</div></div></div>'}</div>
      <div class="kbd"><code>OK</code> ê¸°ë¡ ì‘ì„± Â· <code>MENU</code> í™ˆ</div>
    `;
    requestAnimationFrame(ensureActiveInView);
  }

  function renderSettings() {
    const nick = getNick();

    el.view.innerHTML = `
      ${renderHeader('Settings', 'ë‹‰ë„¤ì„')}
      <div class="detail">
        <div style="display:flex; gap:8px; align-items:center;">
          <input id="nickInput" value="${escapeAttr(nick)}" placeholder="ì˜ˆ) joon" style="flex:1;">
          <button class="btn primary" id="saveNick">ì €ì¥</button>
        </div>

        <div class="cta">
          <button class="btn" id="refreshBtn">ìƒˆë¡œê³ ì¹¨</button>
          <button class="btn" id="loadRuns">ë‚´ Runs</button>
        </div>

        <div style="font-size:11px; color:var(--muted); line-height:1.45;">
          * Runs ê¸°ë¡ ì €ì¥/ê³µìœ ëŠ” ë‹‰ë„¤ì„ì´ í•„ìš”í•¨
        </div>
      </div>
      <div class="kbd"><code>MENU</code> í™ˆ</div>
    `;

    document.getElementById('saveNick').addEventListener('click', () => {
      const v = document.getElementById('nickInput').value.trim();
      setNick(v);
      showToast('ì €ì¥ë¨', v ? `ë‹‰ë„¤ì„: ${v}` : 'ë¹„ì›Œë’€ì–´');
      render();
    });

    document.getElementById('refreshBtn').addEventListener('click', async () => {
      showToast('ê°±ì‹ ', 'ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦');
      await refreshAll();
    });

    document.getElementById('loadRuns').addEventListener('click', async () => {
      state.page = 'runs';
      await refreshRuns();
    });
  }

  function renderAbout() {
    el.view.innerHTML = `
      ${renderHeader('About', 'RunRank')}
      <div class="detail">
        <div style="font-weight:900;">ì¡°ì‘</div>
        <div style="font-size:11px; color: var(--muted); line-height:1.45;">
          - íœ  íšŒì „/ì¢Œìš° ë²„íŠ¼: ë©”ë‰´ ì´ë™<br/>
          - OK: ì„ íƒ / Runsì—ì„œëŠ” ê¸°ë¡ ì‘ì„±<br/>
          - PLAY: Tracksì—ì„œ ì²´í¬(âœ“) <br/>
        </div>
      </div>
      <div class="kbd"><code>MENU</code> í™ˆ</div>
    `;
  }

  function renderDetail() {
    const t = state.selectedTrack;
    if (!t) { state.page = 'tracks'; return renderTracks(); }

    const cover = pickCoverUrl(t);
    const name = safeText(t.title || t.name || t.track || `Track ${t.id ?? ''}`);
    const artist = safeText(t.artist || t.singer || t.by || '');
    const id = t.id ?? t.track_id ?? t.trackId;

    const box = state.voteArmed ? 'â˜‘' : 'â˜';

    el.view.innerHTML = `
      ${renderHeader('Track', 'íˆ¬í‘œ')}
      <div class="detail">
        <div style="display:flex; gap:10px; align-items:center;">
          <div class="thumb" style="width:56px;height:56px;border-radius:12px;">
            ${cover ? `<img alt="" src="${cover}" onerror="this.remove()">` : 'â™ª'}
          </div>
          <div style="min-width:0;">
            <div style="font-weight:900; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${escapeHtml(name)}</div>
            <div style="font-size:11px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${escapeHtml(artist || ' ')}</div>
          </div>
        </div>

        <div style="margin-top:10px; display:flex; align-items:center; gap:10px;">
          <button class="btn" id="voteBox" aria-label="Vote toggle">${box}</button>
          <div style="font-size:12px; color:var(--muted); line-height:1.35;">
            ì²´í¬(â˜â†’â˜‘) í›„ <b style="color:var(--text);">OK</b> ëˆ„ë¥´ë©´ íˆ¬í‘œë¨
          </div>
        </div>

        <div class="cta" style="margin-top:10px;">
          <button class="btn" id="backBtn">ë’¤ë¡œ</button>
        </div>
      </div>
      <div class="kbd"><code>OK</code> íˆ¬í‘œ(â˜‘ì¼ ë•Œ) Â· <code>PLAY</code> íŠ¸ë™ ì²´í¬ Â· <code>MENU</code> í™ˆ</div>
    `;

    document.getElementById('backBtn').addEventListener('click', () => goBack());
    document.getElementById('voteBox').addEventListener('click', () => {
      state.voteArmed = !state.voteArmed;
      renderDetail();
    });

    state._detailTrackId = Number(id);
  }

  function renderRunCreate() {
    const nick = getNick().trim();
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    const defaultDate = `${yyyy}-${mm}-${dd}`;

    const checked = Array.from(state.checkedTrackIds || []);
    const pickedTxt = checked.length
      ? `ì„ íƒí•œ ë…¸ë˜ ${checked.length}ê°œê°€ ê¸°ë¡ì— ì €ì¥ë¼ (ì„œë²„ì—ì„œ ìë™ íˆ¬í‘œë„ ì‹œë„í•¨)`
      : `ì„ íƒí•œ ë…¸ë˜ê°€ ì—†ì–´. Tracksì—ì„œ PLAYë¡œ ì²´í¬í•˜ë©´ ê°™ì´ ì €ì¥ ê°€ëŠ¥`;

    el.view.innerHTML = `
      ${renderHeader('Run', 'ê¸°ë¡ ì‘ì„±')}
      <div class="detail">
        <div style="font-size:12px; color:var(--muted); line-height:1.45;">
          ${escapeHtml(pickedTxt)}
        </div>

        <div style="display:flex; gap:8px; align-items:center; margin-top:8px;">
          <input id="runDate" value="${escapeAttr(defaultDate)}" placeholder="ì˜ˆ) 2026-02-08" style="flex:1;" />
        </div>

        <div style="display:flex; gap:8px; align-items:center;">
          <input id="runDist" inputmode="decimal" placeholder="ê±°ë¦¬(km) ì˜ˆ) 5.2" style="flex:1;" />
        </div>

        <div style="display:flex; gap:8px; align-items:center;">
          <input id="runDur" inputmode="numeric" placeholder="ì‹œê°„(mm:ss) ì˜ˆ) 24:30" style="flex:1;" />
        </div>

        <div style="display:flex; gap:8px; align-items:center;">
          <input id="runPhoto" type="file" accept="image/*" style="flex:1;" />
        </div>

        <div class="cta">
          <button class="btn" id="runCancel">ì·¨ì†Œ</button>
          <button class="btn primary" id="runSave">ì €ì¥</button>
        </div>

        <div style="font-size:11px; color:var(--muted); line-height:1.45;">
          * ë‹‰ë„¤ì„ì´ ì—†ìœ¼ë©´ ì €ì¥ì´ ì•ˆ ë¼. Settingsì—ì„œ ë‹‰ë„¤ì„ ë¨¼ì € ì €ì¥í•´.
        </div>
      </div>
      <div class="kbd"><code>BACK</code> ì·¨ì†Œ Â· <code>OK</code> ì €ì¥</div>
    `;

    document.getElementById('runCancel').addEventListener('click', () => { state.page='runs'; render(); });
    document.getElementById('runSave').addEventListener('click', () => submitRunCreate());
  }

  function parseMmSs(s) {
    const t = String(s || '').trim();
    if (!t) return null;
    const m = t.match(/^(\d+)\s*:\s*(\d{1,2})$/);
    if (!m) return null;
    const mm = parseInt(m[1], 10);
    const ss = parseInt(m[2], 10);
    if (!Number.isFinite(mm) || !Number.isFinite(ss) || ss >= 60) return null;
    return mm * 60 + ss;
  }

  async function submitRunCreate() {
    const nick = getNick().trim();
    if (!nick) { showToast('Runs', 'Settingsì—ì„œ ë‹‰ë„¤ì„ ë¨¼ì € ì €ì¥í•´'); return; }

    const date_label = document.getElementById('runDate')?.value?.trim() || '';
    const distance_km = parseFloat(document.getElementById('runDist')?.value || '');
    const duration_sec = parseMmSs(document.getElementById('runDur')?.value || '');
    const photo = document.getElementById('runPhoto')?.files?.[0] || null;

    if (!date_label) { showToast('Runs', 'ë‚ ì§œë¥¼ ì…ë ¥í•´'); return; }
    if (!Number.isFinite(distance_km) || distance_km <= 0) { showToast('Runs', 'ê±°ë¦¬(km)ë¥¼ ì œëŒ€ë¡œ ì…ë ¥í•´'); return; }
    if (!Number.isFinite(duration_sec) || duration_sec <= 0) { showToast('Runs', 'ì‹œê°„(mm:ss)ì„ ì œëŒ€ë¡œ ì…ë ¥í•´'); return; }

    const fd = new FormData();
    fd.append('user', nick);
    fd.append('distance_km', String(distance_km));
    fd.append('duration_sec', String(duration_sec));
    fd.append('date_label', date_label);

    const checked = Array.from(state.checkedTrackIds || []);
    if (checked.length) fd.append('track_ids', checked.join(','));
    if (photo) fd.append('photo', photo);

    try {
      const res = await fetch('/api/runs', { method:'POST', body: fd });
      const data = await res.json().catch(()=> ({}));
      if (!res.ok || data?.ok === false) throw new Error(data?.error || String(res.status));

      showToast('Runs', 'ì €ì¥ ì™„ë£Œ');
      state.selectedRun = {
        id: data.id,
        user: nick,
        date_label,
        distance_km,
        duration_sec,
        pace: data.pace || '',
        photo_url: data.photo_url || null,
        tracks: checked,
      };
      state.page = 'run_detail';
      await refreshRuns();
      render();
    } catch (e) {
      showToast('Runs ì‹¤íŒ¨', String(e.message || e).slice(0,80));
    }
  }

  function renderRunDetail() {
    const r = state.selectedRun;
    if (!r) { state.page='runs'; return renderRuns(); }

    const date = r.date_label || '';
    const dist = r.distance_km ?? '';
    const dur = (r.duration_sec != null) ? fmtDur(r.duration_sec) : '';
    const pace = r.pace || '';
    const photo = r.photo_url;

    const text =
      `ğŸƒ RunRank ê¸°ë¡\n` +
      `ë‚ ì§œ: ${date}\n` +
      `ê±°ë¦¬: ${dist}km\n` +
      `ì‹œê°„: ${dur}\n` +
      (pace ? `í˜ì´ìŠ¤: ${pace}\n` : '');

    el.view.innerHTML = `
      ${renderHeader('Run', 'ì €ì¥ë¨')}
      <div class="detail">
        <div style="display:flex; gap:10px; align-items:center;">
          <div class="thumb" style="width:56px;height:56px;border-radius:12px;">
            ${photo ? `<img alt="" src="${escapeAttr(photo)}" onerror="this.remove()">` : 'ğŸƒ'}
          </div>
          <div style="min-width:0;">
            <div style="font-weight:900; font-size:13px;">${escapeHtml(date || 'Run')}</div>
            <div style="font-size:11px; color:var(--muted);">
              ${escapeHtml(String(dist))}km Â· ${escapeHtml(dur)}${pace ? ` Â· ${escapeHtml(pace)}` : ''}
            </div>
          </div>
        </div>

        <div class="cta" style="margin-top:10px;">
          <button class="btn" id="runBackBtn">ëª©ë¡</button>
          <button class="btn primary" id="runShareBtn">ê³µìœ </button>
        </div>

        <div style="font-size:11px; color:var(--muted); line-height:1.45;">
          * SNSìš© ì´ë¯¸ì§€ ê³µìœ ëŠ” ì œì™¸í–ˆê³ , ì¹´í†¡/ë©”ì‹ ì €ìš© í…ìŠ¤íŠ¸ ê³µìœ ë§Œ ì§€ì›.
        </div>
      </div>
      <div class="kbd"><code>BACK</code> ëª©ë¡ Â· <code>OK</code> ê³µìœ </div>
    `;

    document.getElementById('runBackBtn').addEventListener('click', ()=>{ state.page='runs'; render(); });
    document.getElementById('runShareBtn').addEventListener('click', async ()=>{ await shareRunText(text); });

    state._shareRunText = text;
  }

  async function shareRunText(text) {
    const payload = { title: 'RunRank ê¸°ë¡', text: text };
    if (navigator.share) {
      try { await navigator.share(payload); return; } catch (e) {}
    }
    try {
      await navigator.clipboard.writeText(text);
      showToast('ê³µìœ ', 'í…ìŠ¤íŠ¸ë¥¼ ë³µì‚¬í–ˆì–´ (ì¹´í†¡ì— ë¶™ì—¬ë„£ê¸°)');
    } catch (e) {
      alert(text);
    }
  }

  function goTo(page) { state.page = page; state.listIndex = 0; render(); }

  function goBack() {
    if (state.page === 'detail') { state.voteArmed = false; state.page = 'tracks'; return render(); }
    if (state.page === 'run_create') { state.page = 'runs'; return render(); }
    if (state.page === 'run_detail') { state.page = 'runs'; return render(); }
    state.page = 'menu'; render();
  }

  function moveUp(){ if (state.page === 'menu') state.menuIndex--; else state.listIndex--; render(); }
  function moveDown(){ if (state.page === 'menu') state.menuIndex++; else state.listIndex++; render(); }

  function select(){
    // OK behavior
    if (state.page === 'detail') {
      const tid = state._detailTrackId;
      if (!tid) { showToast('íˆ¬í‘œ', 'íŠ¸ë™ ì •ë³´ê°€ ì—†ì–´'); return; }
      if (!state.voteArmed) { showToast('íˆ¬í‘œ', 'ì²´í¬(â˜) í›„ OKë¥¼ ëˆŒëŸ¬'); return; }
      state.voteArmed = false;
      submit(tid);
      return;
    }

    if (state.page === 'run_detail') {
      if (state._shareRunText) shareRunText(state._shareRunText);
      return;
    }

    if (state.page === 'run_create') {
      submitRunCreate();
      return;
    }

    if (state.page === 'menu'){
      const key = MENU[clampIndex(state.menuIndex, MENU.length)]?.key;
      if (key === 'runs') { state.page = 'runs'; refreshRuns(); return; }
      return goTo(key || 'tracks');
    }
    if (state.page === 'tracks'){
      const list = state.tracks || [];
      const t = list[clampIndex(state.listIndex, list.length)];
      if (!t) return;
      state.selectedTrack = t;
      state.selectedRun = null;
      state.voteArmed = false;
      state.page = 'detail';
      return render();
    }
    if (state.page === 'runs'){
      state.selectedRun = null;
      state.page = 'run_create';
      return render();
    }
  }

  function toggleCheck() {
    let id = null;
    if (state.page === 'tracks') {
      const list = state.tracks || [];
      const t = list[clampIndex(state.listIndex, list.length)];
      id = t?.id ?? t?.track_id ?? t?.trackId;
    } else if (state.page === 'detail') {
      id = state.selectedTrack?.id ?? state.selectedTrack?.track_id ?? state.selectedTrack?.trackId;
    }
    if (id == null) return;
    id = Number(id);

    if (state.checkedTrackIds.has(id)) {
      state.checkedTrackIds.delete(id);
      showToast('í•´ì œ', `ì„ íƒê³¡ ${state.checkedTrackIds.size}ê°œ`);
    } else {
      state.checkedTrackIds.add(id);
      showToast('ì²´í¬', `ì„ íƒê³¡ ${state.checkedTrackIds.size}ê°œ`);
    }
    render();
  }

  function attachClickWheelRotation() {
    const wheel = document.querySelector('.wheel');
    const center = document.getElementById('btnCenter');
    if (!wheel || !center) return;
    if (wheel.dataset.bound === '1') return;
    wheel.dataset.bound = '1';

    let dragging = false;
    let lastAngle = 0;
    let accum = 0;
    const STEP_DEG = 22;

    function angleFromEvent(ev) {
      const r = wheel.getBoundingClientRect();
      const cx = r.left + r.width / 2;
      const cy = r.top + r.height / 2;
      const x = ev.clientX - cx;
      const y = ev.clientY - cy;
      let a = Math.atan2(y, x) * 180 / Math.PI;
      if (a < 0) a += 360;
      return a;
    }
    function isOnOuterRing(ev) {
      const r = wheel.getBoundingClientRect();
      const cx = r.left + r.width / 2;
      const cy = r.top + r.height / 2;
      const dx = ev.clientX - cx;
      const dy = ev.clientY - cy;
      const dist = Math.sqrt(dx * dx + dy * dy);
      const outer = r.width / 2;
      const inner = outer * 0.33;
      return dist <= outer && dist >= inner;
    }

    function rotateStep(dir) {
      if (state.page === 'menu') {
        state.menuIndex = clampIndex(state.menuIndex + dir, MENU.length);
        render(); return;
      }
      const listLen =
        state.page === 'tracks' ? (state.tracks || []).length :
        state.page === 'ranking' ? (state.ranking || []).length :
        state.page === 'hot' ? (state.hot || []).length :
        state.page === 'runs' ? (state.runs || []).length : 0;

      if (listLen > 0) {
        state.listIndex = clampIndex(state.listIndex + dir, listLen);
        render();
      }
    }

    wheel.addEventListener('pointerdown', (ev) => {
      if (ev.target === center || center.contains(ev.target) || ev.target.closest('.wheelBtn')) return;
      if (!isOnOuterRing(ev)) return;
      ev.preventDefault();
      dragging = true;
      lastAngle = angleFromEvent(ev);
      accum = 0;
      wheel.setPointerCapture(ev.pointerId);
    });

    wheel.addEventListener('pointermove', (ev) => {
      if (!dragging) return;
      if (!isOnOuterRing(ev)) return;
      const a = angleFromEvent(ev);
      let delta = a - lastAngle;
      if (delta > 180) delta -= 360;
      if (delta < -180) delta += 360;
      lastAngle = a;
      accum += delta;
      while (accum >= STEP_DEG) { rotateStep(+1); accum -= STEP_DEG; }
      while (accum <= -STEP_DEG) { rotateStep(-1); accum += STEP_DEG; }
    });

    wheel.addEventListener('pointerup', () => { dragging = false; });
    wheel.addEventListener('pointercancel', () => { dragging = false; });
  }

  function bind() {
    const tap = (node, fn) => {
      node.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); fn(); });
      node.addEventListener('touchend', (e) => { e.preventDefault(); e.stopPropagation(); fn(); }, { passive:false });
    };

    tap(el.btnMenu, () => { state.voteArmed = false; state.page = 'menu'; render(); });
    tap(el.btnPrev, moveUp);
    tap(el.btnNext, moveDown);
    tap(el.btnCenter, select);
    tap(el.btnPlay, toggleCheck);

    attachClickWheelRotation();

    window.addEventListener('keydown', (e) => {
      const k = e.key;
      if (k === 'ArrowUp') { e.preventDefault(); moveUp(); }
      else if (k === 'ArrowDown') { e.preventDefault(); moveDown(); }
      else if (k === 'Enter') { e.preventDefault(); select(); }
      else if (k === 'Escape') { e.preventDefault(); goBack(); }
      else if (k === ' ') { e.preventDefault(); toggleCheck(); }
    });

    window.addEventListener('online', () => setTimeout(checkOnline, 300));
    window.addEventListener('offline', () => setTimeout(checkOnline, 300));
  }

  function tick() { el.clock.textContent = fmtClock(); }

  // boot
  bind();
  tick();
  setInterval(tick, 1000 * 10);

  window.addEventListener('load', () => {
    startOnlineMonitor();
    refreshAll();
  });
})();
</script>
</body>
</html>



