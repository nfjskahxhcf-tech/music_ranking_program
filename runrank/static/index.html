#ì…€g

<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RunRank</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 16px; }
    h1 { margin: 0 0 12px; }
    h2 { margin: 18px 0 10px; }
    .row { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px; align-items: center; }
    button { padding:10px 12px; border:1px solid #ddd; border-radius:10px; background:#fff; cursor:pointer; }
    button:active { transform: scale(0.99); }
    input { padding:10px 12px; border:1px solid #ddd; border-radius:10px; }
    .card { border:1px solid #eee; border-radius:14px; padding:12px; }
    .title { font-weight:800; }
    .artist { color:#666; font-size: 14px; margin-top:2px; }
    .votes { margin-top:8px; font-size: 14px; }
    .small { color:#666; font-size: 12px; }
    .grid { display:grid; gap:10px; }
    .split { display:grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 820px) { .split { grid-template-columns: 1fr 1fr; } }

    .pill { display:inline-block; padding:6px 10px; border:1px solid #eee; border-radius:999px; font-size:12px; color:#555; }
    .ok { color:#0b7; }
    .err { color:#d33; }
  </style>
</head>
<body>
  <h1>RunRank</h1>

  <div class="row">
    <input id="user" placeholder="user(í•„ìˆ˜: ì¤‘ë³µíˆ¬í‘œ ë°©ì§€ìš©)" />
    <button id="refresh">ê³¡ ë¶ˆëŸ¬ì˜¤ê¸°</button>
    <button id="showRank">ì „ì²´ ë­í‚¹</button>
    <button id="showHot">ğŸ”¥ í•« ë­í‚¹(24h)</button>
    <span id="status" class="pill">status: ...</span>
  </div>

  <div class="small">
    âœ… <b>ìœ ì €ë³„ í•˜ë£¨ 1ê³¡ 1í‘œ</b> ì œí•œ(ê¸°ì¤€: KST).<br/>
    ğŸ”¥ í•« ë­í‚¹ì€ â€œìµœê·¼ íˆ¬í‘œâ€ì— ê°€ì¤‘ì¹˜(24h ê¸°ë³¸).
  </div>

  <div class="split">
    <div>
      <h2>Tracks</h2>
      <div id="tracks" class="grid"></div>
    </div>

    <div>
      <h2>Ranking</h2>

      <div class="row">
        <input id="fromTs" placeholder="from_ts (UTC ISO ì˜ˆ: 2026-02-01T00:00:00)" style="flex:1; min-width: 240px;" />
        <input id="toTs" placeholder="to_ts (UTC ISO ì˜ˆ: 2026-02-08T00:00:00)" style="flex:1; min-width: 240px;" />
        <button id="rankPeriod">ê¸°ê°„(ëˆ„ì ) ë­í‚¹</button>
      </div>

      <div class="row">
        <button id="setTodayKST">KST ì˜¤ëŠ˜(00~24)</button>
        <button id="setLast7dKST">KST ìµœê·¼ 7ì¼</button>
        <button id="clearRange">ê¸°ê°„ ì§€ìš°ê¸°</button>
        <span class="small">â€» KST ê¸°ì¤€ìœ¼ë¡œ ì¡ê³  â†’ UTC ISOë¡œ ë³€í™˜í•´ ì „ì†¡</span>
      </div>

      <div class="row">
        <input id="tau" placeholder="í•« ë­í‚¹ tau_hours (ê¸°ë³¸ 24)" style="width:240px;" />
        <button id="showHotCustom">ğŸ”¥ í•« ë­í‚¹(tau)</button>
      </div>

      <div id="ranking" class="grid"></div>
    </div>
  </div>

<script>
const $ = (id) => document.getElementById(id);

async function api(path, options) {
  const res = await fetch(path, options);
  return await res.json();
}

// ---------- KST helpers (KST range -> UTC ISO string) ----------
function kstTodayStartDate() {
  const now = new Date();
  const utcMs = now.getTime();
  const kstMs = utcMs + (9 * 60 * 60 * 1000);
  const kst = new Date(kstMs);
  const y = kst.getUTCFullYear();
  const m = kst.getUTCMonth();
  const d = kst.getUTCDate();
  return new Date(Date.UTC(y, m, d, 0, 0, 0));
}

function kstDaysAgoStartDate(daysAgo) {
  const start = kstTodayStartDate();
  return new Date(start.getTime() - daysAgo * 24 * 60 * 60 * 1000);
}

function kstDateToUtcIso(dtKst) {
  const utcMs = dtKst.getTime() - (9 * 60 * 60 * 1000);
  const utc = new Date(utcMs);
  return utc.toISOString().slice(0,19);
}

function setRangeTodayKST() {
  const startKst = kstTodayStartDate();
  const endKst = new Date(startKst.getTime() + 24*60*60*1000);
  $("fromTs").value = kstDateToUtcIso(startKst);
  $("toTs").value   = kstDateToUtcIso(endKst);
}

function setRangeLast7dKST() {
  const startKst = kstDaysAgoStartDate(7);
  const endKst = new Date(kstTodayStartDate().getTime() + 24*60*60*1000);
  $("fromTs").value = kstDateToUtcIso(startKst);
  $("toTs").value   = kstDateToUtcIso(endKst);
}

function clearRange() {
  $("fromTs").value = "";
  $("toTs").value = "";
}

// ---------- UI builders ----------
function getUserOrWarn() {
  const user = $("user").value.trim();
  if (!user) {
    $("status").textContent = "status: user required";
    $("status").className = "pill err";
    alert("user(ë‹‰ë„¤ì„) ì…ë ¥ í•„ìˆ˜! (ìœ ì €ë³„ í•˜ë£¨ 1ê³¡ 1í‘œ ì œí•œìš©)");
    return null;
  }
  return user;
}

function trackCard(t) {
  const div = document.createElement("div");
  div.className = "card";
  div.innerHTML = `
    <div class="title">${t.title}</div>
    <div class="artist">${t.artist}</div>
    <div class="row" style="margin-top:10px;">
      <button>âœ… ì´ ê³¡ íˆ¬í‘œ (+1)</button>
      <span class="small">id: ${t.id}</span>
      <span class="small" id="tv_${t.id}"></span>
    </div>
  `;

  div.querySelector("button").onclick = async () => {
    const user = getUserOrWarn();
    if (!user) return;

    const out = await api("/api/submit", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ track_id: t.id, user })
    });

    if (!out.ok) {
      $("status").textContent = "status: submit error";
      $("status").className = "pill err";
      alert(out.error || "ì—ëŸ¬");
      return;
    }

    const v = document.getElementById(`tv_${t.id}`);
    if (v) v.textContent = `í˜„ì¬ ë“í‘œ: ${out.current_votes} (KST ${out.vote_day_kst})`;

    $("status").textContent = "status: voted âœ…";
    $("status").className = "pill ok";

    await loadRanking("");
  };

  return div;
}

function rankCard(r, idx, mode) {
  const div = document.createElement("div");
  div.className = "card";

  if (mode === "hot") {
    div.innerHTML = `
      <div class="title">#${idx+1} ${r.title}</div>
      <div class="artist">${r.artist}</div>
      <div class="votes">hot score: <b>${r.score}</b></div>
    `;
  } else {
    div.innerHTML = `
      <div class="title">#${idx+1} ${r.title}</div>
      <div class="artist">${r.artist}</div>
      <div class="votes">votes: <b>${r.votes}</b></div>
    `;
  }
  return div;
}

// ---------- loaders ----------
async function loadHealth() {
  const out = await api("/api/health");
  if (out.ok) {
    $("status").textContent = `status: ok (tracks ${out.tracks_count})`;
    $("status").className = "pill ok";
  } else {
    $("status").textContent = "status: health error";
    $("status").className = "pill err";
  }
}

async function loadTracks() {
  const tracks = await api("/api/tracks");
  const box = $("tracks");
  box.innerHTML = "";
  tracks.forEach(t => box.appendChild(trackCard(t)));
}

async function loadRanking(params="") {
  const out = await api("/api/ranking" + params);
  if (out.ok === false) {
    $("status").textContent = "status: ranking error";
    $("status").className = "pill err";
    alert(out.error || "ë­í‚¹ ì—ëŸ¬");
    return;
  }
  const box = $("ranking");
  box.innerHTML = "";
  out.forEach((r, i) => box.appendChild(rankCard(r, i, "normal")));
  $("status").textContent = "status: ranking updated";
  $("status").className = "pill ok";
}

async function loadHotRanking(tauHours=24) {
  const out = await api(`/api/hot_ranking?tau_hours=${encodeURIComponent(tauHours)}`);
  if (out.ok === false) {
    $("status").textContent = "status: hot ranking error";
    $("status").className = "pill err";
    alert(out.error || "í•«ë­í‚¹ ì—ëŸ¬");
    return;
  }
  const box = $("ranking");
  box.innerHTML = "";
  out.forEach((r, i) => box.appendChild(rankCard(r, i, "hot")));
  $("status").textContent = `status: hot ranking (tau=${tauHours}h)`;
  $("status").className = "pill ok";
}

// ---------- handlers ----------
$("refresh").onclick = loadTracks;
$("showRank").onclick = () => loadRanking("");
$("showHot").onclick = () => loadHotRanking(24);

$("showHotCustom").onclick = () => {
  const s = $("tau").value.trim();
  const tau = s ? Number(s) : 24;
  if (!Number.isFinite(tau) || tau <= 0) {
    alert("tau_hoursëŠ” 0ë³´ë‹¤ í° ìˆ«ìì—¬ì•¼ í•¨");
    return;
  }
  loadHotRanking(tau);
};

$("rankPeriod").onclick = () => {
  const fromTs = $("fromTs").value.trim();
  const toTs = $("toTs").value.trim();
  const qs = new URLSearchParams();
  if (fromTs) qs.set("from_ts", fromTs);
  if (toTs) qs.set("to_ts", toTs);
  const params = qs.toString() ? ("?" + qs.toString()) : "";
  loadRanking(params);
};

$("setTodayKST").onclick = () => { setRangeTodayKST(); $("rankPeriod").click(); };
$("setLast7dKST").onclick = () => { setRangeLast7dKST(); $("rankPeriod").click(); };
$("clearRange").onclick = () => { clearRange(); loadRanking(""); };

// init
loadHealth();
loadTracks();
loadRanking("");
</script>
</body>
</html>
